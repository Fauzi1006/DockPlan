<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DockPlan - Executive Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
    
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; overflow-x: hidden; }
        
        /* --- SETTINGAN DASAR DESKTOP (LAPTOP) --- */
        .sidebar { 
            width: 260px; 
            background: #0f172a; 
            color: #e2e8f0; 
            position: fixed; 
            top: 0; left: 0; height: 100%; 
            z-index: 50; 
            border-right: 1px solid #1e293b; 
            transition: all 0.3s;
            display: flex; flex-direction: column;
            overflow: hidden;
        }
        .sidebar.collapsed { width: 70px; }
        .sidebar.collapsed .logo-text, .sidebar.collapsed .nav-text { display: none; }
        .sidebar.collapsed .nav-item { justify-content: center; padding: 14px 0; }
        
        .nav-item { 
            display: flex; align-items: center; 
            padding: 12px 20px; margin: 6px 12px; 
            border-radius: 8px; font-size: 13px; font-weight: 600; 
            cursor: pointer; transition: all 0.2s; color: #94a3b8; 
        }
        .nav-item.active { background: #3b82f6; color: white; box-shadow: 0 4px 15px rgba(59,130,246,0.4); }
        
        .main-content { margin-left: 260px; transition: margin-left 0.3s; padding-bottom: 40px; }
        .main-content.expanded { margin-left: 70px; }
        
        /* Sembunyikan elemen mobile di desktop */
        .mobile-only-btn { display: none; }
        .desktop-logo { display: flex; }

        /* --- KHUSUS TAMPILAN HP (MOBILE) --- */
        @media (max-width: 768px) {
            .sidebar {
                width: 100% !important;
                height: 70px; 
                top: auto; bottom: 0; left: 0;
                flex-direction: row; 
                justify-content: space-around; 
                padding: 0;
                border-top: 2px solid #334155;
                box-shadow: 0 -4px 20px rgba(0,0,0,0.2);
                z-index: 9999; 
            }

            .main-content { margin-left: 0 !important; padding-bottom: 200px !important; }
            .main-content.expanded { margin-left: 0 !important; }

            .desktop-logo { display: none !important; }
            .mobile-only-btn { display: flex; flex-direction: column; align-items: center; justify-content: center; color: #ef4444; }

            .nav-item {
                flex-direction: column; 
                margin: 0; padding: 8px 0;
                width: 100%; text-align: center;
                border-radius: 0;
                font-size: 10px; 
                justify-content: center;
            }
            .nav-item i { margin-bottom: 4px; font-size: 18px; }
            .nav-item .nav-text { display: block; font-size: 9px; }
            
            .sidebar > div.p-4 { display: none; } 
            
            .copyright-footer { bottom: 70px; font-size: 8px; padding: 5px; }
        }

        /* STATS CARDS & TABLES */
        .stat-card { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); border: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center; transition: transform 0.2s; }
        .stat-card:hover { transform: translateY(-2px); }
        .icon-box { width: 48px; height: 48px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 20px; }

        .table-container { background: white; border-radius: 12px; box-shadow: 0 5px 20px rgba(0,0,0,0.05); overflow: hidden; border: 2px solid #64748b; }
        table { border-collapse: collapse; width: 100%; table-layout: fixed; }
        thead { background: #1e293b; color: #ffffff; }
        thead th { padding: 14px 4px; font-size: 11px; font-weight: 800; border: 2px solid #475569; vertical-align: middle; }
        td { padding: 10px 4px; font-size: 11px; border: 2px solid #94a3b8; vertical-align: middle; text-align: center; word-wrap: break-word; font-weight: 700; }
        
        tbody tr:nth-child(even) { background-color: #f8fafc; }
        tbody tr:hover { background-color: #e2e8f0; }
        
        /* UTILS */
        input[type="checkbox"] { width: 16px; height: 16px; cursor: pointer; accent-color: #2563eb; }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        
        .form-input { width: 100%; padding: 10px; border: 1px solid #cbd5e1; border-radius: 6px; font-size: 12px; text-transform: uppercase; font-weight: 700; outline: none; transition: border 0.2s; }
        .form-input:focus { border-color: #3b82f6; ring: 2px solid #bfdbfe; }
        .swal2-input { margin: 5px 0 !important; font-size: 14px !important; }
        .status-waiting { color: #dc2626; font-size: 10px; font-weight: 800; letter-spacing: 0.5px; }

        /* SCROLLBAR */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 4px; }
        
        /* FOOTER */
        .copyright-footer {
            position: fixed; 
            bottom: 0; 
            left: 0; 
            width: 100%;
            text-align: center; 
            padding: 10px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(5px);
            border-top: 1px solid #e2e8f0;
            font-size: 10px; 
            font-weight: 700; 
            color: #94a3b8; 
            text-transform: uppercase; 
            letter-spacing: 1px;
            z-index: 40; 
            pointer-events: none;
        }

        @media (max-width: 768px) {
            .copyright-footer {
                bottom: 70px !important; 
                font-size: 8px; 
                padding: 5px;
            }
        }
    </style>
</head>
<body class="h-screen flex overflow-hidden">

    <aside id="sidebar" class="sidebar">
        <div class="desktop-logo h-16 w-full items-center px-6 border-b border-white/10 bg-[#0b1120]">
            <div class="w-8 h-8 rounded-lg bg-blue-600 flex items-center justify-center shadow-lg mr-3 shrink-0">
                <i class="fas fa-truck-fast text-white text-sm"></i>
            </div>
            <div class="logo-text"> 
                <h1 class="text-white font-bold text-lg tracking-tight">DockPlan</h1>
                <p class="text-[9px] text-slate-400 font-bold uppercase tracking-widest">Logistic System</p>
            </div>
        </div>

        <nav class="flex-1 w-full py-0 md:py-6 space-y-0 md:space-y-2 flex md:block items-center md:items-stretch justify-around">
            
            <div onclick="showPage('dashboard-stats')" id="menu-dashboard-stats" class="nav-item active">
                <i class="fas fa-chart-line w-5 text-center"></i>
                <span class="nav-text">DASHBOARD</span>
            </div>

            <div onclick="showPage('input')" id="menu-input" class="nav-item">
                <i class="fas fa-keyboard w-5 text-center"></i>
                <span class="nav-text">INPUT</span>
            </div>
            
            <div onclick="showPage('dashboard')" id="menu-dashboard" class="nav-item">
                <i class="fas fa-desktop w-5 text-center"></i>
                <span class="nav-text">MONITOR</span>
            </div>

            <div onclick="showPage('history')" id="menu-history" class="nav-item">
                <i class="fas fa-history w-5 text-center"></i>
                <span class="nav-text">HISTORY</span>
            </div>

            <div onclick="logout()" class="nav-item mobile-only-btn">
                <i class="fas fa-sign-out-alt w-5 text-center"></i>
                <span class="nav-text">KELUAR</span>
            </div>
        </nav>

        <div class="p-4 border-t border-white/10 space-y-2 w-full hidden md:block">
            <button onclick="logout()" class="w-full py-2 rounded bg-red-600 text-white text-[10px] font-bold hover:bg-red-700 transition flex items-center justify-center gap-2 shadow-lg">
                <i class="fas fa-sign-out-alt"></i> KELUAR
            </button>

            <button onclick="resetData()" class="w-full py-2 rounded bg-slate-800 text-slate-400 text-[10px] font-bold hover:text-white transition flex items-center justify-center gap-2">
                <i class="fas fa-trash-alt"></i> RESET DATA
            </button>
        </div>
    </aside>

    <main id="main-content" class="main-content flex-1 h-full overflow-y-auto pb-20 relative">
        <header class="bg-white h-16 border-b border-gray-200 flex items-center justify-between px-6 sticky top-0 z-30 shadow-sm/50 backdrop-blur-md bg-white/90">
            <div class="flex items-center gap-4">
                <button onclick="toggleSidebar()" class="text-slate-400 hover:text-blue-600 transition"><i class="fas fa-bars text-lg"></i></button>
                <div>
                    <h2 class="text-lg font-bold text-slate-800 tracking-tight">DOCKING PLANNING SYSTEM</h2>
                    <p class="text-[10px] text-blue-600 font-bold uppercase tracking-wide" id="page-subtitle">ANALYTICS & PERFORMANCE</p>
                </div>
            </div>
            <div class="flex items-center gap-3">
                <div class="text-right hidden sm:block">
                    <p class="text-[10px] font-bold text-slate-700">Logistic Admin</p>
                    <p class="text-[9px] text-slate-400">Plant Karawang</p>
                </div>
                <div class="w-8 h-8 rounded-full bg-slate-100 border border-slate-200 flex items-center justify-center text-slate-600 shadow-inner"><i class="fas fa-user-tie text-sm"></i></div>
            </div>
        </header>

        <div class="p-6 max-w-[100%] mx-auto">

            <div id="view-dashboard-stats" class="space-y-6">
                <div class="grid grid-cols-2 md:grid-cols-4 gap-3 md:gap-6">
                    <div class="stat-card border-l-4 border-slate-600 p-4 flex-col md:flex-row justify-center md:justify-between">
                        <div class="text-center md:text-left w-full">
                            <p class="text-[9px] font-bold text-slate-500 uppercase tracking-widest truncate">CLOSED SHIPMENT</p>
                            <h3 class="text-2xl md:text-3xl font-black text-slate-800 leading-none mt-1" id="analytic-total">0</h3>
                        </div>
                    </div>
                    <div class="stat-card border-l-4 border-blue-600 p-4 flex-col md:flex-row justify-center md:justify-between">
                        <div class="text-center md:text-left w-full">
                            <p class="text-[9px] font-bold text-slate-500 uppercase tracking-widest truncate">AVG LEAD TIME</p>
                            <h3 class="text-2xl md:text-3xl font-black text-blue-600 leading-none mt-1"><span id="analytic-avg">0</span> <span class="text-[10px] text-slate-400 uppercase">Hari</span></h3>
                        </div>
                    </div>
                    <div class="stat-card border-l-4 border-emerald-500 p-4 flex-col md:flex-row justify-center md:justify-between">
                        <div class="text-center md:text-left w-full">
                            <p class="text-[9px] font-bold text-slate-500 uppercase tracking-widest truncate">FASTEST DELIVERY</p>
                            <h3 class="text-2xl md:text-3xl font-black text-emerald-600 leading-none mt-1"><span id="analytic-min">0</span> <span class="text-[10px] text-slate-400 uppercase">Hari</span></h3>
                        </div>
                    </div>
                    <div class="stat-card border-l-4 border-red-500 p-4 flex-col md:flex-row justify-center md:justify-between">
                        <div class="text-center md:text-left w-full">
                            <p class="text-[9px] font-bold text-slate-500 uppercase tracking-widest truncate">LONGEST DELIVERY</p>
                            <h3 class="text-2xl md:text-3xl font-black text-red-600 leading-none mt-1"><span id="analytic-max">0</span> <span class="text-[10px] text-slate-400 uppercase">Hari</span></h3>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-6">
                    <div class="bg-white p-5 rounded-xl border border-slate-200 shadow-sm">
                        <h4 class="text-[11px] font-bold text-slate-600 mb-4 uppercase tracking-wider"><i class="fas fa-chart-bar text-blue-500 mr-2"></i> Distribusi Lead Time</h4>
                        <canvas id="chartDistribution"></canvas>
                    </div>
                    <div class="bg-white p-5 rounded-xl border border-slate-200 shadow-sm">
                        <h4 class="text-[11px] font-bold text-slate-600 mb-4 uppercase tracking-wider"><i class="fas fa-chart-line text-emerald-500 mr-2"></i> Trend Performa Bulanan</h4>
                        <canvas id="chartMonthly"></canvas>
                    </div>
                    <div class="bg-white p-5 rounded-xl border border-slate-200 shadow-sm md:col-span-2 lg:col-span-1 lg:mx-auto lg:w-2/3">
                        <h4 class="text-[11px] font-bold text-slate-600 mb-4 uppercase tracking-wider text-center"><i class="fas fa-chart-pie text-red-500 mr-2"></i> Kecepatan Proses (≤3 Hari vs >3 Hari)</h4>
                        <div class="relative h-64">
                            <canvas id="chartFastSlow"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="view-dashboard" class="hidden space-y-6">
                <div class="grid grid-cols-3 gap-2 md:gap-6">
    
                    <div class="stat-card border-l-2 md:border-l-4 border-blue-600 p-2 md:p-5 flex-col md:flex-row items-start md:items-center justify-center md:justify-between">
                        <div class="text-center md:text-left w-full">
                            <p class="text-[8px] md:text-[10px] font-bold text-slate-500 uppercase tracking-widest truncate">TOTAL</p>
                            <h3 class="text-xl md:text-3xl font-black text-slate-800 leading-none mt-1" id="stat-total">0</h3>
                        </div>
                        <div class="icon-box bg-blue-50 text-blue-600 hidden md:flex"><i class="fas fa-layer-group"></i></div>
                    </div>

                    <div class="stat-card border-l-2 md:border-l-4 border-red-500 p-2 md:p-5 flex-col md:flex-row items-start md:items-center justify-center md:justify-between">
                        <div class="text-center md:text-left w-full">
                            <p class="text-[8px] md:text-[10px] font-bold text-slate-500 uppercase tracking-widest truncate">PENDING</p>
                            <h3 class="text-xl md:text-3xl font-black text-red-600 leading-none mt-1" id="stat-pending">0</h3>
                        </div>
                        <div class="icon-box bg-red-50 text-red-600 hidden md:flex"><i class="fas fa-hourglass-half animate-pulse"></i></div>
                    </div>

                    <div class="stat-card border-l-2 md:border-l-4 border-emerald-500 p-2 md:p-5 flex-col md:flex-row items-start md:items-center justify-center md:justify-between">
                        <div class="text-center md:text-left w-full">
                            <p class="text-[8px] md:text-[10px] font-bold text-slate-500 uppercase tracking-widest truncate">TERKONFIRMASI</p>
                            <h3 class="text-xl md:text-3xl font-black text-emerald-600 leading-none mt-1" id="stat-confirmed">0</h3>
                        </div>
                        <div class="icon-box bg-emerald-50 text-emerald-600 hidden md:flex"><i class="fas fa-calendar-check"></i></div>
                    </div>

                </div>

                <div class="flex flex-col md:flex-row justify-between items-center gap-3 bg-white p-4 rounded-xl border border-slate-200 shadow-sm">
                    <div class="relative w-full md:w-[350px]">
                        <i class="fas fa-search absolute left-3 top-3 text-slate-400 text-xs"></i>
                        <input type="search" id="searchInput" autocomplete="new-password" readonly onfocus="this.removeAttribute('readonly');" onblur="this.setAttribute('readonly','readonly');" onkeyup="renderTable()" placeholder="Cari DN, Vendor, Unit, Driver..." class="pl-9 pr-3 py-2.5 bg-slate-50 border border-slate-200 rounded-lg w-full text-xs font-bold text-slate-700 focus:outline-none focus:ring-2 focus:ring-blue-500 uppercase transition">
                    </div>
                    
                    <div class="flex gap-2">
                        <button id="btn-delete-bulk" onclick="deleteSelected()" disabled class="bg-red-500 text-white px-4 py-2.5 rounded-lg text-[10px] font-bold hover:bg-red-600 transition shadow flex items-center gap-2 disabled:bg-slate-200 disabled:text-slate-400">
                            <i class="fas fa-trash-alt"></i> HAPUS (<span id="selected-count">0</span>)
                        </button>

                        <button onclick="exportToExcel()" class="bg-emerald-600 text-white px-4 py-2.5 rounded-lg text-[10px] font-bold hover:bg-emerald-700 transition shadow flex items-center gap-2">
                            <i class="fas fa-file-excel"></i> EXCEL
                        </button>
                    </div>
                </div>

                <div id="mobile-view" class="md:hidden space-y-4 mb-20">
                </div>

                <div class="table-container hidden md:block">
                    <div class="overflow-x-auto">
                        <table class="w-full" id="monitoringTable">
                            <thead>
                                <tr>
                                    <th style="width: 30px;"><input type="checkbox" id="checkAll" onclick="toggleSelectAll()"></th>
                                    <th style="width: 35px;">NO</th>
                                    <th style="width: 80px;">CREATED</th>
                                    <th style="width: 120px;">NO DN</th>
                                    <th style="width: 150px;">CUSTOMER</th>
                                    <th style="width: 80px;">KOTA</th>
                                    <th style="width: 60px;">QTY<br>(TON)</th>
                                    <th style="width: 80px;">UNIT</th>
                                    <th style="width: 100px;">VENDOR</th>
                                    <th style="width: 120px;">NOPOL &<br>DRIVER</th>
                                    <th style="width: 100px;">STUFFING<br>(DATE)</th>
                                    <th style="width: 100px;">BONGKAR<br>(DATE)</th>
                                    <th style="width: 50px;">EDIT</th>
                                </tr>
                            </thead>
                            <tbody id="table-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="view-history" class="hidden space-y-6">
                <div class="flex flex-col md:flex-row justify-between items-center gap-3 bg-white p-4 rounded-xl border border-slate-200 shadow-sm">
                    <div class="relative w-full md:w-[350px]">
                        <i class="fas fa-search absolute left-3 top-3 text-slate-400 text-xs"></i>
                        <input type="search" id="searchHistoryInput" autocomplete="new-password" readonly onfocus="this.removeAttribute('readonly');" onblur="this.setAttribute('readonly','readonly');" onkeyup="renderHistory()" placeholder="Cari DN, Vendor, Unit (History)..." class="pl-9 pr-3 py-2.5 bg-slate-50 border border-slate-200 rounded-lg w-full text-xs font-bold text-slate-700 focus:outline-none focus:ring-2 focus:ring-blue-500 uppercase transition">
                    </div>
                    
                    <div class="flex gap-2">
                        <button id="btn-delete-history" onclick="deleteSelected()" disabled class="bg-red-500 text-white px-4 py-2.5 rounded-lg text-[10px] font-bold hover:bg-red-600 transition shadow flex items-center gap-2 disabled:bg-slate-200 disabled:text-slate-400">
                            <i class="fas fa-trash-alt"></i> HAPUS (<span id="selected-count-history">0</span>)
                        </button>
                    </div>
                </div>

                <div id="mobile-view-history" class="md:hidden space-y-4 mb-20"></div>

                <div class="table-container hidden md:block">
                    <div class="overflow-x-auto">
                        <table class="w-full" id="historyTable">
                            <thead>
                                <tr>
                                    <th style="width: 30px;"><input type="checkbox" id="checkAllHistory" onclick="toggleSelectAllHistory()"></th>
                                    <th style="width: 35px;">NO</th>
                                    <th style="width: 80px;">CREATED</th>
                                    <th style="width: 120px;">NO DN</th>
                                    <th style="width: 150px;">CUSTOMER</th>
                                    <th style="width: 80px;">KOTA</th>
                                    <th style="width: 60px;">QTY<br>(TON)</th>
                                    <th style="width: 80px;">UNIT</th>
                                    <th style="width: 100px;">VENDOR</th>
                                    <th style="width: 120px;">NOPOL &<br>DRIVER</th>
                                    <th style="width: 100px;">STUFFING<br>(DATE)</th>
                                    <th style="width: 100px;">BONGKAR<br>(DATE)</th>
                                    <th style="width: 60px;">STATUS</th> 
                                </tr>
                            </thead>
                            <tbody id="table-body-history"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="view-input" class="hidden max-w-6xl mx-auto space-y-6">
                
                <div class="bg-white rounded-xl shadow-lg border border-slate-200 overflow-hidden">
                    <div class="px-6 py-4 border-b border-gray-100 bg-blue-50 flex justify-between items-center">
                        <h3 class="font-bold text-slate-800 flex items-center gap-2 text-sm"><i class="fas fa-file-import text-blue-600"></i> A. IMPORT DATA SAP (MASSAL)</h3>
                    </div>
                    <div class="p-6 space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="text-[10px] font-bold text-slate-500 uppercase block mb-1">AUTO VENDOR (OPSIONAL)</label>
                                <input type="text" id="input-vendor-batch" class="form-input" placeholder="ISI JIKA 1 BATCH = 1 VENDOR">
                            </div>
                            <div>
                                <label class="text-[10px] font-bold text-slate-500 uppercase block mb-1">AUTO UNIT (OPSIONAL)</label>
                                <input type="text" id="input-unit-batch" class="form-input" placeholder="ISI JIKA UNIT SAMA SEMUA">
                            </div>
                        </div>
                        <div>
                             <textarea id="paste-area" class="w-full h-32 p-3 border border-slate-300 rounded-lg font-mono text-xs focus:ring-2 focus:ring-blue-500 outline-none shadow-inner bg-slate-50 text-slate-700 uppercase" placeholder="PASTE DATA DARI SAP/EXCEL DISINI..."></textarea>
                        </div>
                        <div class="flex justify-end">
                            <button onclick="processPaste()" class="px-6 py-2 rounded-lg text-xs font-bold text-white bg-blue-600 hover:bg-blue-700 shadow-lg transition uppercase flex items-center gap-2">
                                <i class="fas fa-check-circle"></i> PROSES IMPORT
                            </button>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow-lg border border-slate-200 overflow-hidden">
                    <div class="px-6 py-4 border-b border-gray-100 bg-emerald-50 flex justify-between items-center">
                        <h3 class="font-bold text-slate-800 flex items-center gap-2 text-sm"><i class="fas fa-keyboard text-emerald-600"></i> B. INPUT MANUAL (SATU PER SATU)</h3>
                    </div>
                    <div class="p-6">
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
                            <div><label class="text-[10px] font-bold text-slate-500 block mb-1">NO DN</label><input id="man-dn" class="form-input"></div>
                            <div><label class="text-[10px] font-bold text-slate-500 block">CUSTOMER</label><input id="man-cust" class="form-input"></div>
                            <div><label class="text-[10px] font-bold text-slate-500 block">KOTA</label><input id="man-kota" class="form-input"></div>
                            <div><label class="text-[10px] font-bold text-slate-500 block">QTY (TON)</label><input type="number" id="man-qty" class="form-input"></div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                            <div><label class="text-[10px] font-bold text-slate-500 block mb-1">JENIS UNIT</label><input id="man-unit" class="form-input"></div>
                            <div><label class="text-[10px] font-bold text-slate-500 block">VENDOR</label><input id="man-vendor" class="form-input"></div>
                            <div><label class="text-[10px] font-bold text-slate-500 block">NOPOL</label><input id="man-nopol" class="form-input"></div>
                            <div><label class="text-[10px] font-bold text-slate-500 block">DRIVER</label><input id="man-driver" class="form-input"></div>
                        </div>
                        <div class="flex justify-end gap-3">
                            <button onclick="showPage('dashboard')" class="px-5 py-2 rounded-lg text-xs font-bold text-slate-500 hover:bg-slate-200 transition uppercase">BATAL</button>
                            <button onclick="saveManual()" class="px-6 py-2 rounded-lg text-xs font-bold text-white bg-emerald-600 hover:bg-emerald-700 shadow-lg transition uppercase flex items-center gap-2">
                                <i class="fas fa-save"></i> SIMPAN DATA MANUAL
                            </button>
                        </div>
                    </div>
                </div>

            </div>

        </div>
    </main>

    <div class="copyright-footer">
        2026 Copy Right Ahmad Fauzi - DockPlan System - ALL RIGHTS RESERVED
    </div>

    <div id="login-screen" class="fixed inset-0 bg-[#0f172a] z-[100] flex items-center justify-center transition-all duration-500 hidden">
        <div class="bg-white p-8 rounded-2xl shadow-2xl w-96 border border-slate-600 text-center">
            <div class="w-16 h-16 bg-blue-600 rounded-xl flex items-center justify-center mx-auto mb-4 shadow-lg shadow-blue-500/50">
                <i class="fas fa-key text-white text-2xl"></i>
            </div>
            <h2 class="text-2xl font-black text-slate-800 mb-1 tracking-tight">DOCKPLAN SYSTEM</h2>
            <p class="text-[10px] font-bold text-slate-400 mb-6 uppercase tracking-widest">Silakan Login</p>
            
            <div class="space-y-4 text-left">
                <div>
                    <label class="text-[10px] font-bold text-slate-500 ml-1">USERNAME</label>
                    <input type="text" id="username-input" class="w-full p-3 bg-slate-100 border border-slate-300 rounded-lg text-xs font-bold focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Masukkan Username">
                </div>
                <div>
                    <label class="text-[10px] font-bold text-slate-500 ml-1">PASSWORD</label>
                    <input type="password" id="password-input" class="w-full p-3 bg-slate-100 border border-slate-300 rounded-lg text-xs font-bold focus:ring-2 focus:ring-blue-500 outline-none" placeholder="******">
                </div>
                <button onclick="prosesLogin()" class="w-full py-3 bg-slate-800 text-white rounded-lg font-bold text-sm hover:bg-slate-900 transition shadow-lg flex items-center justify-center gap-2">
                    <i class="fas fa-sign-in-alt"></i> MASUK
                </button>
            </div>
            <p class="mt-6 text-[10px] text-slate-400 font-bold">INDAH KIAT KARAWANG - 2026</p>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
    // --- 1. KONEKSI FIREBASE ---
    const firebaseConfig = {
      apiKey: "AIzaSyCHs4mqUYjDvdWH-HU0E6PGWsUu4yJG-kk",
      authDomain: "dockplan-system.firebaseapp.com",
      projectId: "dockplan-system",
      storageBucket: "dockplan-system.firebasestorage.app",
      messagingSenderId: "487876305197",
      appId: "1:487876305197:web:9a1d642d00f0bdf52fb3a4"
    };

    if (typeof firebase === 'undefined') {
        alert("ERROR: Script Firebase Library belum dimuat di bagian paling atas!");
    } else {
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    }
    
    const db = firebase.firestore();
    const auth = firebase.auth();

    // --- 2. VARIABEL GLOBAL ---
    let localData = []; 
    let USER_ROLE = ''; 
    let USER_NAME = ''; 
    let chartDistInstance = null;
    let chartMonthlyInstance = null;
    let chartFastSlowInstance = null;

    // --- 3. SISTEM LOGIN ---
    function prosesLogin() {
        const email = document.getElementById('username-input').value.trim().toLowerCase();
        const pass = document.getElementById('password-input').value.trim();

        if (!email || !pass) { alert('Harap isi Email dan Password!'); return; }

        const btnLogin = document.querySelector('button[onclick="prosesLogin()"]');
        const textAsli = btnLogin.innerHTML;
        btnLogin.innerHTML = 'MOHON TUNGGU...';
        btnLogin.disabled = true;

        auth.signInWithEmailAndPassword(email, pass)
            .then((cred) => {
                return db.collection('users').doc(email).get();
            })
            .then((doc) => {
                if (doc.exists) {
                    const data = doc.data();
                    localStorage.setItem('dockplan_session', JSON.stringify(data));
                    masukAplikasi(data.role, data.nama);
                    alert(`Login Berhasil!\nSelamat Datang, ${data.nama}`); 
                } else {
                    alert('GAGAL: Email benar, tapi belum disetup.');
                    auth.signOut();
                }
            })
            .catch((err) => {
                let msg = err.message;
                if(err.code === 'auth/invalid-credential') msg = "Password atau Email Salah.";
                alert('Login Gagal: ' + msg);
            })
            .finally(() => {
                btnLogin.innerHTML = textAsli;
                btnLogin.disabled = false;
            });
    }

    auth.onAuthStateChanged((user) => {
        if (user) {
            db.collection('users').doc(user.email).get().then((doc) => {
                if(doc.exists) {
                    const d = doc.data();
                    masukAplikasi(d.role, d.nama);
                }
            });
        } else {
            document.getElementById('login-screen').classList.remove('hidden');
        }
    });

    function masukAplikasi(role, nama) {
        USER_ROLE = role;
        USER_NAME = nama.toUpperCase(); 

        document.getElementById('login-screen').classList.add('hidden');
        const subtitle = document.getElementById('page-subtitle');
        if(subtitle) subtitle.innerText = `ANALYTICS & PERFORMANCE`;

        // ATUR MENU
        const btnInput = document.getElementById('menu-input');
        const btnDelete = document.getElementById('btn-delete-bulk');
        const btnDeleteHistory = document.getElementById('btn-delete-history');
        const btnReset = document.querySelector('button[onclick="resetData()"]');
        
        if (role === 'ADMIN') {
            if(btnInput) btnInput.style.display = 'flex';
            if(btnDelete) btnDelete.style.display = 'flex';
            if(btnDeleteHistory) btnDeleteHistory.style.display = 'flex';
            if(btnReset) btnReset.style.display = 'flex';
        } else {
            if(btnInput) btnInput.style.display = 'none';
            if(btnDelete) btnDelete.style.display = 'none';
            if(btnDeleteHistory) btnDeleteHistory.style.display = 'none';
            if(btnReset) btnReset.style.display = 'none';
        }

        const searchBox = document.getElementById('searchInput');
        if(searchBox) searchBox.value = '';

        // Default open analytics on login
        renderAnalytics();
        updateStats();
    }

    function logout() {
        if (confirm("Yakin ingin keluar?")) {
            localStorage.removeItem('dockplan_session'); 
            auth.signOut().then(() => location.reload());
        }
    }

    // --- 4. RENDER TABLE & LOGIC ---
    db.collection("bookings").orderBy("created", "desc").onSnapshot((snapshot) => {
        localData = [];
        snapshot.forEach((doc) => {
            let d = doc.data();
            d.id = doc.id;
            localData.push(d);
        });
        
        const activePage = document.querySelector('.nav-item.active').id;
        if(activePage === 'menu-history') {
            renderHistory();
        } else if (activePage === 'menu-dashboard-stats') {
            renderAnalytics();
        } else {
            renderTable();
        }
        updateStats(); 
    });

    // --- HELPER: IS HISTORY? ---
    function isHistory(bongkarDateStr) {
        if (!bongkarDateStr) return false;
        const today = new Date();
        today.setHours(0,0,0,0);
        
        const bongkarDate = new Date(bongkarDateStr);
        const limit = new Date(bongkarDate);
        limit.setDate(limit.getDate() + 1);
        
        return today > limit;
    }

    // --- RENDER ANALYTICS (Dashboard Stats) ---
    function renderAnalytics() {
        let dataTampil = localData;

        // Role Filtering
        if (USER_ROLE === 'VENDOR') {
            dataTampil = dataTampil.filter(item => item.vendor && item.vendor.toUpperCase() === USER_NAME);
        } else if (USER_ROLE === 'CUSTOMER') {
            dataTampil = dataTampil.filter(item => item.customer && item.customer.toUpperCase() === USER_NAME);
        }

        // Filter Hanya CLOSED (History Logic) yang memiliki stuffing dan bongkar
        dataTampil = dataTampil.filter(item => isHistory(item.bongkar) && item.stuffing && item.bongkar);

        let totalClosed = dataTampil.length;
        let sumDays = 0, minDays = Infinity, maxDays = -1;
        let dist = { '0-1': 0, '2-3': 0, '4-5': 0, '>5': 0 };
        let monthly = {};

        dataTampil.forEach(item => {
            const dStuffing = new Date(item.stuffing);
            const dBongkar = new Date(item.bongkar);
            dStuffing.setHours(0,0,0,0);
            dBongkar.setHours(0,0,0,0);

            const diffDays = Math.max(0, Math.ceil((dBongkar - dStuffing) / (1000 * 60 * 60 * 24)));

            // Basic Stats
            sumDays += diffDays;
            if (diffDays < minDays) minDays = diffDays;
            if (diffDays > maxDays) maxDays = diffDays;

            // Distribution
            if (diffDays <= 1) dist['0-1']++;
            else if (diffDays <= 3) dist['2-3']++;
            else if (diffDays <= 5) dist['4-5']++;
            else dist['>5']++;

            // Monthly Trend (Based on Bongkar Date)
            const m = dBongkar.getMonth();
            const y = dBongkar.getFullYear();
            const key = `${y}-${String(m + 1).padStart(2, '0')}`;
            
            if (!monthly[key]) {
                monthly[key] = { count: 0, sum: 0, label: dBongkar.toLocaleString('id-ID', { month: 'short', year: 'numeric' }) };
            }
            monthly[key].count++;
            monthly[key].sum += diffDays;
        });

        // Fallbacks
        if (minDays === Infinity) minDays = 0;
        if (maxDays === -1) maxDays = 0;
        let avgDays = totalClosed > 0 ? (sumDays / totalClosed).toFixed(1) : 0;

        // Update DOM Stats Cards
        document.getElementById('analytic-total').innerText = totalClosed;
        document.getElementById('analytic-avg').innerText = avgDays;
        document.getElementById('analytic-min').innerText = minDays;
        document.getElementById('analytic-max').innerText = maxDays;

        // Prepare Chart Data
        const distLabels = ['0-1 Hari', '2-3 Hari', '4-5 Hari', '> 5 Hari'];
        const distData = [dist['0-1'], dist['2-3'], dist['4-5'], dist['>5']];

        const sortedMonthKeys = Object.keys(monthly).sort();
        const monthLabels = sortedMonthKeys.map(k => monthly[k].label);
        const monthDataAvg = sortedMonthKeys.map(k => (monthly[k].sum / monthly[k].count).toFixed(1));
        const monthDataTotal = sortedMonthKeys.map(k => monthly[k].count);

        const fastCount = dist['0-1'] + dist['2-3'];
        const slowCount = dist['4-5'] + dist['>5'];

        // Destroy Old Charts
        if (chartDistInstance) chartDistInstance.destroy();
        if (chartMonthlyInstance) chartMonthlyInstance.destroy();
        if (chartFastSlowInstance) chartFastSlowInstance.destroy();

        // Render Bar Chart (Distribusi)
        const ctxDist = document.getElementById('chartDistribution').getContext('2d');
        chartDistInstance = new Chart(ctxDist, {
            type: 'bar',
            data: {
                labels: distLabels,
                datasets: [{
                    label: 'Jumlah Shipment',
                    data: distData,
                    backgroundColor: '#3b82f6',
                    borderRadius: 4
                }]
            },
            options: { responsive: true, scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } } }
        });

        // Render Line Chart (Trend Bulanan)
        const ctxMonthly = document.getElementById('chartMonthly').getContext('2d');
        chartMonthlyInstance = new Chart(ctxMonthly, {
            type: 'line',
            data: {
                labels: monthLabels,
                datasets: [
                    {
                        label: 'Avg Lead Time (Hari)',
                        data: monthDataAvg,
                        borderColor: '#ef4444',
                        backgroundColor: '#ef4444',
                        tension: 0.3,
                        yAxisID: 'y'
                    },
                    {
                        type: 'bar',
                        label: 'Total Shipment',
                        data: monthDataTotal,
                        backgroundColor: '#cbd5e1',
                        borderRadius: 4,
                        yAxisID: 'y1'
                    }
                ]
            },
            options: {
                responsive: true,
                scales: {
                    y: { type: 'linear', display: true, position: 'left', title: { display: true, text: 'Lead Time (Hari)' }, beginAtZero: true },
                    y1: { type: 'linear', display: true, position: 'right', grid: { drawOnChartArea: false }, title: { display: true, text: 'Total Shipment' }, beginAtZero: true, ticks: { stepSize: 1 } }
                }
            }
        });

        // Render Doughnut Chart (Fast vs Slow)
        const ctxFastSlow = document.getElementById('chartFastSlow').getContext('2d');
        chartFastSlowInstance = new Chart(ctxFastSlow, {
            type: 'doughnut',
            data: {
                labels: ['Cepat (≤ 3 Hari)', 'Lambat (> 3 Hari)'],
                datasets: [{
                    data: [fastCount, slowCount],
                    backgroundColor: ['#10b981', '#f43f5e'],
                    borderWidth: 0
                }]
            },
            options: { responsive: true, maintainAspectRatio: false }
        });
    }

    // --- RENDER TABLE MONITORING (Exclude History) ---
    function renderTable() {
        let dataTampil = localData;
        const filter = document.getElementById('searchInput').value.toUpperCase();

        if (USER_ROLE === 'VENDOR') {
            dataTampil = dataTampil.filter(item => item.vendor && item.vendor.toUpperCase() === USER_NAME);
        } 
        else if (USER_ROLE === 'CUSTOMER') {
            dataTampil = dataTampil.filter(item => item.customer && item.customer.toUpperCase() === USER_NAME);
        }

        dataTampil = dataTampil.filter(item => !isHistory(item.bongkar));

        if(filter) {
            dataTampil = dataTampil.filter(i => 
                (i.dn && i.dn.includes(filter)) || 
                (i.customer && i.customer.toUpperCase().includes(filter)) ||
                (i.kota && i.kota.toUpperCase().includes(filter)) ||
                (i.unit && i.unit.toUpperCase().includes(filter)) ||
                (i.vendor && i.vendor.toUpperCase().includes(filter)) ||
                (i.nopol && i.nopol.toUpperCase().includes(filter)) ||
                (i.driver && i.driver.toUpperCase().includes(filter))
            );
        }

        const tbody = document.getElementById('table-body');
        const mobileView = document.getElementById('mobile-view');
        
        tbody.innerHTML = ''; 
        mobileView.innerHTML = '';

        document.getElementById('checkAll').checked = false;
        updateDeleteButton();

        if(dataTampil.length === 0) {
            tbody.innerHTML = `<tr><td colspan="13" class="text-center py-10 font-bold text-slate-400">DATA TIDAK DITEMUKAN / SUDAH MASUK HISTORY</td></tr>`;
            mobileView.innerHTML = `<div class="text-center py-10 text-slate-400 font-bold italic">DATA TIDAK DITEMUKAN</div>`;
            return;
        }

        dataTampil.forEach((item, idx) => {
            const dCreated = new Date(item.created);
            const showCreated = `${dCreated.getDate()}/${dCreated.getMonth()+1} ${String(dCreated.getHours()).padStart(2,'0')}:${String(dCreated.getMinutes()).padStart(2,'0')}`;
            
            const formatJadwal = (val) => {
                if(!val) return '<span class="status-waiting text-red-500 font-bold text-[9px]">MENUNGGU<br>KONFIRMASI</span>';
                const d = new Date(val);
                const months = ["JAN", "FEB", "MAR", "APR", "MEI", "JUN", "JUL", "AGU", "SEP", "OKT", "NOV", "DES"];
                return `<div class="text-blue-800 text-[11px] font-bold"><i class="fas fa-calendar-alt mr-1"></i>${d.getDate()} ${months[d.getMonth()]}</div>`;
            };

            const displayQty = Math.round(item.qty).toLocaleString('id-ID');

            const row = `
            <tr class="border-b hover:bg-slate-50 transition">
                <td><input type="checkbox" class="row-chk" value="${item.id}" onclick="updateDeleteButton()"></td>
                <td class="text-center font-bold text-slate-500">${idx+1}</td>
                <td class="text-center text-[10px] font-bold text-slate-400">${showCreated}</td>
                <td class="font-bold text-blue-800 text-[10px]">${item.dn}</td>
                <td class="font-bold text-slate-700 text-[10px]">${item.customer}</td>
                <td class="text-center font-bold text-slate-600 text-[10px]">${item.kota}</td>
                <td class="text-center font-black text-slate-800">${displayQty}</td>
                <td class="text-center font-bold text-slate-600 text-[10px]">${item.unit}</td>
                <td class="text-center font-bold text-slate-600 text-[10px]">${item.vendor || '-'}</td>
                <td class="bg-slate-50 px-2">
                    <div class="font-black text-slate-800 text-[11px] border-b border-slate-200 pb-1">${item.nopol || '-'}</div>
                    <div class="font-bold text-slate-500 text-[9px]">${item.driver || '-'}</div>
                </td>
                <td class="text-center bg-yellow-50 border-x border-slate-200">${formatJadwal(item.stuffing)}</td>
                <td class="text-center bg-green-50 border-r border-slate-200">${formatJadwal(item.bongkar)}</td>
                <td class="text-center">
                    <button onclick="editItem('${item.id}')" class="text-blue-600 hover:bg-blue-100 p-2 rounded transition"><i class="fas fa-edit"></i></button>
                </td>
            </tr>`;
            tbody.innerHTML += row;

            const card = `
            <div class="bg-white p-4 rounded-xl shadow border border-slate-200 mb-3 relative overflow-hidden">
                <div class="flex justify-between items-start border-b pb-2 mb-2">
                    <div class="w-2/3 pr-2">
                        <div class="flex items-center gap-2 mb-1">
                            <span class="bg-slate-800 text-white text-[9px] px-2 py-0.5 rounded font-bold">#${idx + 1}</span>
                            <span class="text-[9px] text-slate-400 font-bold">${showCreated}</span>
                        </div>
                        <h4 class="font-black text-blue-700 text-base leading-tight mb-1 truncate">${item.dn}</h4>
                        <div class="text-[10px] font-bold text-slate-500 uppercase truncate">${item.customer}</div>
                    </div>
                    <div class="text-right w-1/3">
                        <div class="font-black text-xl text-slate-800">${displayQty}</div>
                        <div class="text-[8px] font-bold text-slate-400">TON</div>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-2 mb-2 text-[10px]">
                    <div class="bg-slate-50 p-2 rounded border border-slate-100">
                        <span class="block text-slate-400 font-bold">VENDOR</span>
                        <b class="text-slate-700 truncate block" title="${item.vendor || '-'}">${item.vendor || '-'}</b>
                    </div>
                    <div class="bg-slate-50 p-2 rounded border border-slate-100">
                        <span class="block text-slate-400 font-bold">DRIVER</span>
                        <b class="text-slate-700 truncate block" title="${item.driver} / ${item.nopol}">${item.driver || '-'} / ${item.nopol || '-'}</b>
                    </div>
                </div>
                <div class="flex gap-2 mb-3">
                    <div class="flex-1 bg-yellow-50 p-1.5 rounded border border-yellow-100 text-center">
                        <div class="text-[8px] font-bold text-yellow-700 mb-1">STUFFING</div>
                        ${formatJadwal(item.stuffing)}
                    </div>
                    <div class="flex-1 bg-green-50 p-1.5 rounded border border-green-100 text-center">
                        <div class="text-[8px] font-bold text-green-700 mb-1">BONGKAR</div>
                        ${formatJadwal(item.bongkar)}
                    </div>
                </div>
                <div class="flex justify-between items-center pt-1 gap-2">
                    <label class="flex items-center gap-2 p-1.5 rounded hover:bg-slate-50 cursor-pointer border border-slate-200 flex-1 justify-center">
                        <input type="checkbox" class="row-chk w-4 h-4 accent-blue-600" value="${item.id}" onclick="updateDeleteButton()">
                        <span class="text-[9px] font-bold text-slate-500">PILIH</span>
                    </label>
                    <button onclick="editItem('${item.id}')" class="bg-blue-600 text-white flex-1 py-2 rounded-lg text-[10px] font-bold hover:bg-blue-700 shadow flex items-center justify-center gap-1">
                        <i class="fas fa-edit"></i> EDIT
                    </button>
                </div>
            </div>`;
            mobileView.innerHTML += card;
        });
    }

    // --- RENDER HISTORY TABLE (Only History H+1) ---
    function renderHistory() {
        let dataTampil = localData;
        const filter = document.getElementById('searchHistoryInput').value.toUpperCase();

        if (USER_ROLE === 'VENDOR') {
            dataTampil = dataTampil.filter(item => item.vendor && item.vendor.toUpperCase() === USER_NAME);
        } 
        else if (USER_ROLE === 'CUSTOMER') {
            dataTampil = dataTampil.filter(item => item.customer && item.customer.toUpperCase() === USER_NAME);
        }

        dataTampil = dataTampil.filter(item => isHistory(item.bongkar));

        if(filter) {
            dataTampil = dataTampil.filter(i => 
                (i.dn && i.dn.includes(filter)) || 
                (i.customer && i.customer.toUpperCase().includes(filter)) ||
                (i.kota && i.kota.toUpperCase().includes(filter)) ||
                (i.unit && i.unit.toUpperCase().includes(filter)) ||
                (i.vendor && i.vendor.toUpperCase().includes(filter)) ||
                (i.nopol && i.nopol.toUpperCase().includes(filter)) ||
                (i.driver && i.driver.toUpperCase().includes(filter))
            );
        }

        const tbody = document.getElementById('table-body-history');
        const mobileView = document.getElementById('mobile-view-history');
        
        tbody.innerHTML = ''; 
        mobileView.innerHTML = '';

        document.getElementById('checkAllHistory').checked = false;
        const btnDel = document.getElementById('btn-delete-history');
        if(btnDel) { btnDel.disabled = true; document.getElementById('selected-count-history').innerText = '0'; }

        if(dataTampil.length === 0) {
            tbody.innerHTML = `<tr><td colspan="13" class="text-center py-10 font-bold text-slate-400">DATA HISTORY KOSONG</td></tr>`;
            mobileView.innerHTML = `<div class="text-center py-10 text-slate-400 font-bold italic">DATA HISTORY KOSONG</div>`;
            return;
        }

        dataTampil.forEach((item, idx) => {
            const dCreated = new Date(item.created);
            const showCreated = `${dCreated.getDate()}/${dCreated.getMonth()+1} ${String(dCreated.getHours()).padStart(2,'0')}:${String(dCreated.getMinutes()).padStart(2,'0')}`;
            
            const formatJadwal = (val) => {
                const d = new Date(val);
                const months = ["JAN", "FEB", "MAR", "APR", "MEI", "JUN", "JUL", "AGU", "SEP", "OKT", "NOV", "DES"];
                return `<div class="text-slate-500 text-[11px] font-bold"><i class="fas fa-check-circle mr-1 text-emerald-500"></i>${d.getDate()} ${months[d.getMonth()]}</div>`;
            };

            const displayQty = Math.round(item.qty).toLocaleString('id-ID');

            const row = `
            <tr class="border-b hover:bg-slate-50 transition bg-slate-50/50">
                <td><input type="checkbox" class="row-chk" value="${item.id}" onclick="updateDeleteButton()"></td>
                <td class="text-center font-bold text-slate-400">${idx+1}</td>
                <td class="text-center text-[10px] font-bold text-slate-400">${showCreated}</td>
                <td class="font-bold text-slate-600 text-[10px]">${item.dn}</td>
                <td class="font-bold text-slate-500 text-[10px]">${item.customer}</td>
                <td class="text-center font-bold text-slate-400 text-[10px]">${item.kota}</td>
                <td class="text-center font-bold text-slate-500">${displayQty}</td>
                <td class="text-center font-bold text-slate-400 text-[10px]">${item.unit}</td>
                <td class="text-center font-bold text-slate-400 text-[10px]">${item.vendor || '-'}</td>
                <td class="bg-white/50 px-2">
                    <div class="font-bold text-slate-600 text-[11px] border-b border-slate-200 pb-1">${item.nopol || '-'}</div>
                    <div class="font-bold text-slate-400 text-[9px]">${item.driver || '-'}</div>
                </td>
                <td class="text-center bg-white/50 border-x border-slate-200 grayscale opacity-70">${formatJadwal(item.stuffing)}</td>
                <td class="text-center bg-white/50 border-r border-slate-200 grayscale opacity-70">${formatJadwal(item.bongkar)}</td>
                <td class="text-center">
                    <span class="px-2 py-1 bg-slate-200 text-slate-500 text-[9px] font-black rounded tracking-wide">CLOSED</span>
                </td>
            </tr>`;
            tbody.innerHTML += row;

            const card = `
            <div class="bg-slate-50 p-4 rounded-xl shadow-sm border border-slate-200 mb-3 relative overflow-hidden grayscale-[0.3]">
                <div class="absolute top-0 right-0 bg-slate-200 text-slate-500 text-[8px] font-bold px-2 py-1 rounded-bl">HISTORY</div>
                <div class="flex justify-between items-start border-b border-slate-200 pb-2 mb-2">
                    <div class="w-2/3 pr-2">
                        <div class="flex items-center gap-2 mb-1">
                            <span class="bg-slate-400 text-white text-[9px] px-2 py-0.5 rounded font-bold">#${idx + 1}</span>
                            <span class="text-[9px] text-slate-400 font-bold">${showCreated}</span>
                        </div>
                        <h4 class="font-bold text-slate-600 text-base leading-tight mb-1 truncate">${item.dn}</h4>
                        <div class="text-[10px] font-bold text-slate-400 uppercase truncate">${item.customer}</div>
                    </div>
                    <div class="text-right w-1/3 pt-4">
                        <div class="font-black text-xl text-slate-600">${displayQty}</div>
                        <div class="text-[8px] font-bold text-slate-400">TON</div>
                    </div>
                </div>
                
                <div class="grid grid-cols-2 gap-2 mb-3">
                     <div class="flex-1 bg-white p-1.5 rounded border border-slate-200 text-center">
                        <div class="text-[8px] font-bold text-slate-400 mb-1">BONGKAR (SELESAI)</div>
                        ${formatJadwal(item.bongkar)}
                    </div>
                     <div class="flex-1 flex items-center justify-center">
                        <label class="flex items-center gap-2 p-1.5 rounded hover:bg-slate-100 cursor-pointer border border-slate-200 w-full justify-center bg-white">
                            <input type="checkbox" class="row-chk w-4 h-4 accent-red-600" value="${item.id}" onclick="updateDeleteButton()">
                            <span class="text-[9px] font-bold text-slate-500">PILIH HAPUS</span>
                        </label>
                    </div>
                </div>
            </div>`;
            mobileView.innerHTML += card;
        });
    }

    // --- 5. EDIT LOGIC ---
    function editItem(id) {
        const item = localData.find(i => i.id === id); if(!item) return;

        document.getElementById('edit-id').value = id;
        document.getElementById('edit-dn').value = item.dn;
        document.getElementById('edit-cust').value = item.customer;
        document.getElementById('edit-unit').value = item.unit;
        document.getElementById('edit-qty').value = item.qty;
        document.getElementById('edit-kota').value = item.kota;
        document.getElementById('edit-vendor').value = item.vendor;
        document.getElementById('edit-nopol').value = item.nopol;
        document.getElementById('edit-driver').value = item.driver;
        document.getElementById('edit-stuffing').value = item.stuffing;
        document.getElementById('edit-bongkar').value = item.bongkar;

        const allFields = ['edit-dn','edit-cust','edit-unit','edit-qty','edit-kota','edit-vendor','edit-nopol','edit-driver','edit-stuffing','edit-bongkar'];
        allFields.forEach(f => {
            const el = document.getElementById(f); el.disabled = true; el.style.backgroundColor = '#f1f5f9'; 
        });

        if (USER_ROLE === 'ADMIN') {
            allFields.forEach(f => { document.getElementById(f).disabled = false; document.getElementById(f).style.backgroundColor = 'white'; });
        }
        else if (USER_ROLE === 'VENDOR') {
            ['edit-nopol', 'edit-driver'].forEach(f => {
                const el = document.getElementById(f); el.disabled = false; el.style.backgroundColor = 'white'; el.style.border = '2px solid #3b82f6'; 
            });
        }
        else if (USER_ROLE === 'CUSTOMER') {
            ['edit-bongkar'].forEach(f => {
                const el = document.getElementById(f); el.disabled = false; el.style.backgroundColor = 'white'; el.style.border = '2px solid #22c55e';
            });
        }
        document.getElementById('modal-edit').style.display = 'flex';
    }

    function simpanPerubahan() {
        const id = document.getElementById('edit-id').value;
        const updates = {};

        if (USER_ROLE === 'ADMIN') {
            updates.dn = document.getElementById('edit-dn').value.toUpperCase();
            updates.customer = document.getElementById('edit-cust').value.toUpperCase();
            updates.unit = document.getElementById('edit-unit').value.toUpperCase();
            updates.qty = document.getElementById('edit-qty').value;
            updates.kota = document.getElementById('edit-kota').value.toUpperCase();
            updates.vendor = document.getElementById('edit-vendor').value.toUpperCase();
            updates.nopol = document.getElementById('edit-nopol').value.toUpperCase();
            updates.driver = document.getElementById('edit-driver').value.toUpperCase();
            updates.stuffing = document.getElementById('edit-stuffing').value;
            updates.bongkar = document.getElementById('edit-bongkar').value;
        } 
        else if (USER_ROLE === 'VENDOR') {
            updates.nopol = document.getElementById('edit-nopol').value.toUpperCase();
            updates.driver = document.getElementById('edit-driver').value.toUpperCase();
        } 
        else if (USER_ROLE === 'CUSTOMER') {
            updates.bongkar = document.getElementById('edit-bongkar').value;
        }

        db.collection("bookings").doc(id).update(updates)
            .then(() => { alert('Berhasil Update!'); tutupModal(); })
            .catch((err) => { alert('Gagal: ' + err.message); });
    }

    function tutupModal() { document.getElementById('modal-edit').style.display = 'none'; }
    function resetData() { alert('Fitur reset hanya untuk Admin.'); }
    
    function updateStats() {
        let dataHitung = localData;

        if (USER_ROLE === 'VENDOR') {
            dataHitung = dataHitung.filter(item => item.vendor && item.vendor.toUpperCase() === USER_NAME);
        } 
        else if (USER_ROLE === 'CUSTOMER') {
            dataHitung = dataHitung.filter(item => item.customer && item.customer.toUpperCase() === USER_NAME);
        }

        dataHitung = dataHitung.filter(item => !isHistory(item.bongkar));

        const total = dataHitung.length;
        const confirmed = dataHitung.filter(i => i.stuffing && i.bongkar).length;
        const pending = total - confirmed;

        if(document.getElementById('stat-total')) document.getElementById('stat-total').innerText = total;
        if(document.getElementById('stat-pending')) document.getElementById('stat-pending').innerText = pending;
        if(document.getElementById('stat-confirmed')) document.getElementById('stat-confirmed').innerText = confirmed;
    }

    function toggleSidebar() {
        document.getElementById('sidebar').classList.toggle('collapsed');
        document.getElementById('main-content').classList.toggle('expanded');
    }

    window.showPage = function(pageId) {
        document.getElementById('view-dashboard').classList.add('hidden');
        document.getElementById('view-input').classList.add('hidden');
        document.getElementById('view-history').classList.add('hidden'); 
        document.getElementById('view-dashboard-stats').classList.add('hidden'); 

        document.getElementById('menu-dashboard').classList.remove('active');
        document.getElementById('menu-input').classList.remove('active');
        document.getElementById('menu-history').classList.remove('active');
        document.getElementById('menu-dashboard-stats').classList.remove('active');
        
        document.getElementById(`view-${pageId}`).classList.remove('hidden');
        document.getElementById(`menu-${pageId}`).classList.add('active');
        
        if(pageId === 'dashboard-stats') {
            document.getElementById('page-subtitle').innerText = 'ANALYTICS & PERFORMANCE';
            renderAnalytics();
        } else if(pageId === 'dashboard') {
            document.getElementById('page-subtitle').innerText = 'MONITORING OVERVIEW';
            renderTable();
        } else if (pageId === 'history') {
            document.getElementById('page-subtitle').innerText = 'HISTORY CLOSED DATA';
            renderHistory();
        } else {
            document.getElementById('page-subtitle').innerText = 'DATA ENTRY';
            document.getElementById('input-vendor-batch').value = ''; 
            document.getElementById('paste-area').value = '';
        }

        document.getElementById('checkAll').checked = false;
        document.getElementById('checkAllHistory').checked = false;
        updateDeleteButton();
    }

    // --- CHECKBOX LOGIC ---
    window.toggleSelectAll = function() {
        const isChecked = document.getElementById('checkAll').checked;
        document.querySelectorAll('#table-body .row-chk').forEach(cb => cb.checked = isChecked);
        updateDeleteButton();
    }

    window.toggleSelectAllHistory = function() {
        const isChecked = document.getElementById('checkAllHistory').checked;
        document.querySelectorAll('#table-body-history .row-chk').forEach(cb => cb.checked = isChecked);
        updateDeleteButton();
    }

    window.updateDeleteButton = function() {
        const checkedCount = document.querySelectorAll('.row-chk:checked').length;
        
        if(document.getElementById('selected-count')) {
            document.getElementById('selected-count').innerText = checkedCount;
            document.getElementById('btn-delete-bulk').disabled = checkedCount === 0;
        }

        if(document.getElementById('selected-count-history')) {
            document.getElementById('selected-count-history').innerText = checkedCount;
            document.getElementById('btn-delete-history').disabled = checkedCount === 0;
        }
    }

    window.deleteSelected = function() {
        const checkboxes = document.querySelectorAll('.row-chk:checked');
        if(checkboxes.length === 0) return;

        if (confirm(`Hapus ${checkboxes.length} Data?\nData akan hilang selamanya dari server Google!`)) {
            console.log("Sedang menghapus data...");
            const batch = db.batch(); 
            checkboxes.forEach((cb) => {
                const docId = cb.value; 
                const docRef = db.collection("bookings").doc(docId);
                batch.delete(docRef);
            });

            batch.commit().then(() => {
                alert("Data berhasil dihapus.");
                document.getElementById('checkAll').checked = false;
                document.getElementById('checkAllHistory').checked = false;
                updateDeleteButton(); 
            }).catch((error) => {
                console.error("Gagal hapus:", error);
                alert("Error: Gagal menghapus data: " + error.message);
            });
        }
    }

    window.exportToExcel = function() {
        let db = localData; 
        if(db.length === 0) { alert('Data Kosong'); return; }

        let csvContent = "data:text/csv;charset=utf-8,";
        csvContent += "NO,CREATED,DN,CUSTOMER,KOTA,QTY,UNIT,VENDOR,NOPOL,DRIVER,TGL STUFFING,TGL BONGKAR\n";
        
        db.forEach((item, index) => {
            const created = new Date(item.created).toLocaleDateString('id-ID');
            const cust = item.customer.replace(/,/g, " ");
            const row = [
                index + 1,
                created,
                `'${item.dn}`,
                cust,
                item.kota,
                item.qty,
                item.unit,
                item.vendor,
                item.nopol,
                item.driver,
                item.stuffing || '-',
                item.bongkar || '-'
            ].join(",");
            csvContent += row + "\n";
        });

        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", `DOCKPLAN_DATA_${new Date().getTime()}.csv`);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    function saveManual() {
        const dn = document.getElementById('man-dn').value.toUpperCase();
        const cust = document.getElementById('man-cust').value.toUpperCase();
        
        if(!dn || !cust) {
            alert('No DN dan Customer Wajib Diisi');
            return;
        }

        db.collection("bookings").add({
            created: new Date().toISOString(),
            dn: dn,
            customer: cust,
            kota: document.getElementById('man-kota').value.toUpperCase(),
            qty: parseFloat(document.getElementById('man-qty').value) || 0,
            unit: document.getElementById('man-unit').value.toUpperCase(),
            vendor: document.getElementById('man-vendor').value.toUpperCase(),
            nopol: document.getElementById('man-nopol').value.toUpperCase(),
            driver: document.getElementById('man-driver').value.toUpperCase(),
            stuffing: '', 
            bongkar: '', 
            isGb: false
        }).catch((error) => {
            console.error("Gagal simpan:", error);
        });

        ['man-dn','man-cust','man-kota','man-qty','man-unit','man-vendor','man-nopol','man-driver'].forEach(id => document.getElementById(id).value = '');
        showPage('dashboard');
    }

    function processPaste() {
        const rawText = document.getElementById('paste-area').value;
        const vendorBatch = document.getElementById('input-vendor-batch').value.toUpperCase().trim();
        const unitBatch = document.getElementById('input-unit-batch').value.toUpperCase().trim();
        const inputTime = new Date().toISOString();

        if(!rawText.trim()) { 
            alert('Data Kosong: Silakan paste data dulu');
            return; 
        }

        const lines = rawText.trim().split('\n');
        const groupedData = {};
        let singleDataList = [];

        lines.forEach((line, index) => {
            if(!line.trim()) return;
            const cols = line.split('\t').map(c => c.trim()).filter(c => c !== '');
            if(cols.length < 7) return;

            const dn = cols[1];
            const customer = cols[3];
            const kota = cols[4];
            let qtyRaw = cols[5].replace(/,/g, '');
            let qty = parseFloat(qtyRaw);
            let cleanUnit = unitBatch || '-';
            if(!unitBatch && cols[7]) cleanUnit = cols[7].split(/[ ;.,]/)[0].toUpperCase();

            const gbMatch = line.toUpperCase().match(/GB\s*(\d+)/);
            
            const entry = {
                created: inputTime,
                dn: dn,
                customer: customer,
                kota: kota,
                qty: qty, 
                unit: cleanUnit,
                vendor: vendorBatch || '', 
                nopol: '', driver: '', stuffing: '', bongkar: '',
                isGb: false
            };

            if (gbMatch) {
                const gbCode = "GB" + gbMatch[1];
                if (!groupedData[gbCode]) {
                    groupedData[gbCode] = { ...entry };
                    groupedData[gbCode].dn = [entry.dn];
                } else {
                    groupedData[gbCode].qty += entry.qty;
                    if (!groupedData[gbCode].dn.includes(entry.dn)) {
                        groupedData[gbCode].dn.push(entry.dn);
                    }
                }
            } else {
                singleDataList.push(entry);
            }
        });

        const finalMergedList = [];
        for (const key in groupedData) {
            const item = groupedData[key];
            item.dn = item.dn.join(', ');
            finalMergedList.push(item);
        }
        const allNewData = [...finalMergedList, ...singleDataList];

        if(allNewData.length > 0) {
            const batch = db.batch();
            allNewData.forEach((item) => {
                const docRef = db.collection("bookings").doc();
                batch.set(docRef, item);
            });

            batch.commit()
                .then(() => {
                    console.log("Upload berhasil ke Firebase.");
                    document.getElementById('paste-area').value = '';
                    document.getElementById('input-vendor-batch').value = '';
                    alert(`${allNewData.length} Data berhasil diproses ke server.`);
                    showPage('dashboard');
                })
                .catch(err => {
                    console.error("Gagal batch:", err);
                    alert("Gagal mengirim data ke server: " + err.message);
                });

        } else {
            alert('Gagal: Format data tidak sesuai.');
        }
    }

    window.addEventListener('load', function() {
        const savedUser = localStorage.getItem('dockplan_session');
        if (savedUser) {
            try {
                const data = JSON.parse(savedUser);
                if(data && data.role && data.nama) {
                    console.log("Auto-login berhasil sebagai: " + data.nama);
                    masukAplikasi(data.role, data.nama);
                } else {
                    throw new Error("Data sesi rusak");
                }
            } catch (e) {
                localStorage.removeItem('dockplan_session');
                tampilkanLogin();
            }
        } else {
            tampilkanLogin();
        }

        function tampilkanLogin() {
            const loginScreen = document.getElementById('login-screen');
            if(loginScreen) {
                loginScreen.classList.remove('hidden');
                loginScreen.classList.remove('opacity-0');
                loginScreen.classList.remove('pointer-events-none');
            }
        }
    });
    </script>
    <div id="modal-edit" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999; align-items: center; justify-content: center;">
    <div style="background: white; padding: 20px; width: 90%; max-width: 500px; border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.3); max-height: 90vh; overflow-y: auto;">
        
        <h3 style="margin-bottom: 15px; font-weight: bold; border-bottom: 2px solid #eee; padding-bottom: 10px;">EDIT DATA</h3>
        
        <input type="hidden" id="edit-id">

        <div style="display: grid; gap: 10px;">
            <div>
                <label style="font-size: 10px; font-weight: bold; color: #666;">NO DN</label>
                <input type="text" id="edit-dn" class="form-input" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
            </div>
            <div>
                <label style="font-size: 10px; font-weight: bold; color: #666;">CUSTOMER</label>
                <input type="text" id="edit-cust" class="form-input" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <div>
                    <label style="font-size: 10px; font-weight: bold; color: #666;">UNIT</label>
                    <input type="text" id="edit-unit" class="form-input" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                </div>
                <div>
                    <label style="font-size: 10px; font-weight: bold; color: #666;">QTY</label>
                    <input type="number" id="edit-qty" class="form-input" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                </div>
            </div>
            <div>
                <label style="font-size: 10px; font-weight: bold; color: #666;">KOTA</label>
                <input type="text" id="edit-kota" class="form-input" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
            </div>

            <div style="background: #f0f9ff; padding: 10px; border-radius: 4px; border: 1px solid #bae6fd;">
                <label style="font-size: 10px; font-weight: bold; color: #0284c7; display: block; margin-bottom: 5px;">AREA VENDOR</label>
                <div>
                    <label style="font-size: 10px; font-weight: bold; color: #666;">VENDOR NAME</label>
                    <input type="text" id="edit-vendor" class="form-input" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; margin-bottom: 5px;">
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <div>
                        <label style="font-size: 10px; font-weight: bold; color: #666;">NOPOL</label>
                        <input type="text" id="edit-nopol" class="form-input" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                    </div>
                    <div>
                        <label style="font-size: 10px; font-weight: bold; color: #666;">DRIVER</label>
                        <input type="text" id="edit-driver" class="form-input" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                    </div>
                </div>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <div style="background: #fefce8; padding: 5px; border: 1px solid #fef08a;">
                    <label style="font-size: 10px; font-weight: bold; color: #854d0e;">TGL STUFFING</label>
                    <input type="date" id="edit-stuffing" class="form-input" style="width: 100%; padding: 5px; border: 1px solid #ccc;">
                </div>
                <div style="background: #f0fdf4; padding: 5px; border: 1px solid #bbf7d0;">
                    <label style="font-size: 10px; font-weight: bold; color: #166534;">TGL BONGKAR</label>
                    <input type="date" id="edit-bongkar" class="form-input" style="width: 100%; padding: 5px; border: 1px solid #ccc;">
                </div>
            </div>
        </div>

        <div style="margin-top: 20px; display: flex; justify-content: flex-end; gap: 10px;">
            <button onclick="tutupModal()" style="padding: 10px 20px; background: #94a3b8; color: white; border: none; border-radius: 4px; font-weight: bold; cursor: pointer;">BATAL</button>
            <button onclick="simpanPerubahan()" style="padding: 10px 20px; background: #2563eb; color: white; border: none; border-radius: 4px; font-weight: bold; cursor: pointer;">SIMPAN DATA</button>
        </div>
    </div>
</div>
</body>
</html>
