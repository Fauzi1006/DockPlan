<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DockPlan - Executive Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
    
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; overflow-x: hidden; }
        
        /* SIDEBAR */
        .sidebar { width: 260px; background: #0f172a; color: #e2e8f0; position: fixed; top: 0; left: 0; height: 100%; z-index: 50; border-right: 1px solid #1e293b; transition: all 0.3s; }
        .sidebar.collapsed { width: 70px; }
        .sidebar.collapsed .logo-text, .sidebar.collapsed .nav-text { display: none; }
        .sidebar.collapsed .nav-item { justify-content: center; padding: 14px 0; }
        
        .nav-item { display: flex; align-items: center; padding: 14px 20px; margin: 6px 12px; border-radius: 8px; font-size: 13px; font-weight: 600; cursor: pointer; transition: all 0.2s; color: #94a3b8; }
        .nav-item.active { background: #3b82f6; color: white; box-shadow: 0 4px 15px rgba(59,130,246,0.4); }

        /* MAIN CONTENT */
        .main-content { margin-left: 260px; transition: margin-left 0.3s; padding-bottom: 40px; }
        .main-content.expanded { margin-left: 70px; }

        /* COPYRIGHT FOOTER */
        .copyright-footer {
            position: fixed; bottom: 0; left: 0; width: 100%;
            text-align: center; padding: 10px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(5px);
            border-top: 1px solid #e2e8f0;
            font-size: 10px; font-weight: 700; color: #94a3b8; text-transform: uppercase; letter-spacing: 1px;
            z-index: 40; pointer-events: none;
        }

        /* STATS CARDS */
        .stat-card { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); border: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center; transition: transform 0.2s; }
        .stat-card:hover { transform: translateY(-2px); }
        .icon-box { width: 48px; height: 48px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 20px; }

        /* TABLE STYLING */
        .table-container { background: white; border-radius: 12px; box-shadow: 0 5px 20px rgba(0,0,0,0.05); overflow: hidden; border: 2px solid #64748b; }
        table { border-collapse: collapse; width: 100%; table-layout: fixed; }
        
        thead { background: #1e293b; color: #ffffff; }
        thead th { 
            padding: 14px 4px; text-align: center; font-size: 11px; font-weight: 800; 
            text-transform: uppercase; letter-spacing: 0.5px; border: 2px solid #475569; 
            vertical-align: middle;
        }
        
        td { 
            padding: 10px 4px; font-size: 11px; color: #334155; border: 2px solid #94a3b8; 
            vertical-align: middle; text-align: center; text-transform: uppercase; 
            word-wrap: break-word; white-space: normal; line-height: 1.3; font-weight: 700;
        }
        
        tbody tr:nth-child(even) { background-color: #f8fafc; }
        tbody tr:hover { background-color: #e2e8f0; }
        
        /* UTILS */
        input[type="checkbox"] { width: 16px; height: 16px; cursor: pointer; accent-color: #2563eb; }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        
        .form-input { width: 100%; padding: 10px; border: 1px solid #cbd5e1; border-radius: 6px; font-size: 12px; text-transform: uppercase; font-weight: 700; outline: none; transition: border 0.2s; }
        .form-input:focus { border-color: #3b82f6; ring: 2px solid #bfdbfe; }
        .swal2-input { margin: 5px 0 !important; font-size: 14px !important; }
        .status-waiting { color: #dc2626; font-size: 10px; font-weight: 800; letter-spacing: 0.5px; }

        /* SCROLLBAR */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 4px; }
    </style>
</head>
<body class="h-screen flex overflow-hidden">

    <aside id="sidebar" class="sidebar flex flex-col">
        <div class="h-16 flex items-center px-6 border-b border-white/10 bg-[#0b1120]">
            <div class="w-8 h-8 rounded-lg bg-blue-600 flex items-center justify-center shadow-lg mr-3 shrink-0">
                <i class="fas fa-truck-fast text-white text-sm"></i>
            </div>
            <div class="logo-text">
                <h1 class="text-white font-bold text-lg tracking-tight">DockPlan</h1>
                <p class="text-[9px] text-slate-400 font-bold uppercase tracking-widest">Logistic System</p>
            </div>
        </div>
        <nav class="flex-1 py-6 space-y-2">
            <div onclick="showPage('input')" id="menu-input" class="nav-item"><i class="fas fa-keyboard w-5 text-center"></i><span class="nav-text">Input Data</span></div>
            <div onclick="showPage('dashboard')" id="menu-dashboard" class="nav-item active"><i class="fas fa-desktop w-5 text-center"></i><span class="nav-text">Monitoring</span></div>
        </nav>
        <div class="p-4 border-t border-white/10 space-y-2">
            
            <button onclick="logout()" class="w-full py-2 rounded bg-red-600 text-white text-[10px] font-bold hover:bg-red-700 transition flex items-center justify-center gap-2 shadow-lg">
                <i class="fas fa-sign-out-alt"></i> KELUAR
            </button>

            <button onclick="resetData()" class="w-full py-2 rounded bg-slate-800 text-slate-400 text-[10px] font-bold hover:text-white transition flex items-center justify-center gap-2">
                <i class="fas fa-trash-alt"></i> RESET DATA
            </button>
            
        </div>
    </aside>

    <main id="main-content" class="main-content flex-1 h-full overflow-y-auto pb-20 relative">
        <header class="bg-white h-16 border-b border-gray-200 flex items-center justify-between px-6 sticky top-0 z-30 shadow-sm/50 backdrop-blur-md bg-white/90">
            <div class="flex items-center gap-4">
                <button onclick="toggleSidebar()" class="text-slate-400 hover:text-blue-600 transition"><i class="fas fa-bars text-lg"></i></button>
                <div>
                    <h2 class="text-lg font-bold text-slate-800 tracking-tight">DOCKING PLANNING SYSTEM</h2>
                    <p class="text-[10px] text-blue-600 font-bold uppercase tracking-wide" id="page-subtitle">Monitoring Overview</p>
                </div>
            </div>
            <div class="flex items-center gap-3">
                <div class="text-right hidden sm:block">
                    <p class="text-[10px] font-bold text-slate-700">Logistic Admin</p>
                    <p class="text-[9px] text-slate-400">Plant Karawang</p>
                </div>
                <div class="w-8 h-8 rounded-full bg-slate-100 border border-slate-200 flex items-center justify-center text-slate-600 shadow-inner"><i class="fas fa-user-tie text-sm"></i></div>
            </div>
        </header>

        <div class="p-6 max-w-[100%] mx-auto">
            
            <div id="view-dashboard" class="space-y-6">
                <div class="grid grid-cols-3 gap-2 md:gap-6">
    
    <div class="stat-card border-l-2 md:border-l-4 border-blue-600 p-2 md:p-5 flex-col md:flex-row items-start md:items-center justify-center md:justify-between">
        <div class="text-center md:text-left w-full">
            <p class="text-[8px] md:text-[10px] font-bold text-slate-500 uppercase tracking-widest truncate">TOTAL</p>
            <h3 class="text-xl md:text-3xl font-black text-slate-800 leading-none mt-1" id="stat-total">0</h3>
        </div>
        <div class="icon-box bg-blue-50 text-blue-600 hidden md:flex"><i class="fas fa-layer-group"></i></div>
    </div>

    <div class="stat-card border-l-2 md:border-l-4 border-red-500 p-2 md:p-5 flex-col md:flex-row items-start md:items-center justify-center md:justify-between">
        <div class="text-center md:text-left w-full">
            <p class="text-[8px] md:text-[10px] font-bold text-slate-500 uppercase tracking-widest truncate">PENDING</p>
            <h3 class="text-xl md:text-3xl font-black text-red-600 leading-none mt-1" id="stat-pending">0</h3>
        </div>
        <div class="icon-box bg-red-50 text-red-600 hidden md:flex"><i class="fas fa-hourglass-half animate-pulse"></i></div>
    </div>

    <div class="stat-card border-l-2 md:border-l-4 border-emerald-500 p-2 md:p-5 flex-col md:flex-row items-start md:items-center justify-center md:justify-between">
        <div class="text-center md:text-left w-full">
            <p class="text-[8px] md:text-[10px] font-bold text-slate-500 uppercase tracking-widest truncate">TERKONFIRMASI</p>
            <h3 class="text-xl md:text-3xl font-black text-emerald-600 leading-none mt-1" id="stat-confirmed">0</h3>
        </div>
        <div class="icon-box bg-emerald-50 text-emerald-600 hidden md:flex"><i class="fas fa-calendar-check"></i></div>
    </div>

</div>

                <div class="flex flex-col md:flex-row justify-between items-center gap-3 bg-white p-4 rounded-xl border border-slate-200 shadow-sm">
                    <div class="relative w-full md:w-[350px]">
                        <i class="fas fa-search absolute left-3 top-3 text-slate-400 text-xs"></i>
                        <input type="text" id="searchInput" onkeyup="renderTable()" placeholder="Cari DN, Vendor, Unit, Driver..." class="pl-9 pr-3 py-2.5 bg-slate-50 border border-slate-200 rounded-lg w-full text-xs font-bold text-slate-700 focus:outline-none focus:ring-2 focus:ring-blue-500 uppercase transition">
                    </div>
                    
                    <div class="flex gap-2">
                        <button id="btn-delete-bulk" onclick="deleteSelected()" disabled class="bg-red-500 text-white px-4 py-2.5 rounded-lg text-[10px] font-bold hover:bg-red-600 transition shadow flex items-center gap-2 disabled:bg-slate-200 disabled:text-slate-400">
                            <i class="fas fa-trash-alt"></i> HAPUS (<span id="selected-count">0</span>)
                        </button>

                        <button onclick="exportToExcel()" class="bg-emerald-600 text-white px-4 py-2.5 rounded-lg text-[10px] font-bold hover:bg-emerald-700 transition shadow flex items-center gap-2">
                            <i class="fas fa-file-excel"></i> EXCEL
                        </button>

                        
                    </div>
                </div>

                <div id="mobile-view" class="md:hidden space-y-4 mb-20">
    </div>

<div class="table-container hidden md:block">
    <div class="overflow-x-auto">
        <table class="w-full" id="monitoringTable">
            <thead>
                <tr>
                    <th style="width: 30px;"><input type="checkbox" id="checkAll" onclick="toggleSelectAll()"></th>
                    <th style="width: 35px;">NO</th>
                    <th style="width: 80px;">CREATED</th>
                    <th style="width: 120px;">NO DN</th>
                    <th style="width: 150px;">CUSTOMER</th>
                    <th style="width: 80px;">KOTA</th>
                    <th style="width: 60px;">QTY<br>(TON)</th>
                    <th style="width: 80px;">UNIT</th>
                    <th style="width: 100px;">VENDOR</th>
                    <th style="width: 120px;">NOPOL &<br>DRIVER</th>
                    <th style="width: 100px;">STUFFING<br>(DATE)</th>
                    <th style="width: 100px;">BONGKAR<br>(DATE)</th>
                    <th style="width: 50px;">EDIT</th>
                </tr>
            </thead>
            <tbody id="table-body"></tbody>
        </table>
    </div>
</div>
            </div>

            <div id="view-input" class="hidden max-w-6xl mx-auto space-y-6">
                
                <div class="bg-white rounded-xl shadow-lg border border-slate-200 overflow-hidden">
                    <div class="px-6 py-4 border-b border-gray-100 bg-blue-50 flex justify-between items-center">
                        <h3 class="font-bold text-slate-800 flex items-center gap-2 text-sm"><i class="fas fa-file-import text-blue-600"></i> A. IMPORT DATA SAP (MASSAL)</h3>
                    </div>
                    <div class="p-6 space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="text-[10px] font-bold text-slate-500 uppercase block mb-1">AUTO VENDOR (OPSIONAL)</label>
                                <input type="text" id="input-vendor-batch" class="form-input" placeholder="ISI JIKA 1 BATCH = 1 VENDOR">
                            </div>
                            <div>
                                <label class="text-[10px] font-bold text-slate-500 uppercase block mb-1">AUTO UNIT (OPSIONAL)</label>
                                <input type="text" id="input-unit-batch" class="form-input" placeholder="ISI JIKA UNIT SAMA SEMUA">
                            </div>
                        </div>
                        <div>
                             <textarea id="paste-area" class="w-full h-32 p-3 border border-slate-300 rounded-lg font-mono text-xs focus:ring-2 focus:ring-blue-500 outline-none shadow-inner bg-slate-50 text-slate-700 uppercase" placeholder="PASTE DATA DARI SAP/EXCEL DISINI..."></textarea>
                        </div>
                        <div class="flex justify-end">
                            <button onclick="processPaste()" class="px-6 py-2 rounded-lg text-xs font-bold text-white bg-blue-600 hover:bg-blue-700 shadow-lg transition uppercase flex items-center gap-2">
                                <i class="fas fa-check-circle"></i> PROSES IMPORT
                            </button>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow-lg border border-slate-200 overflow-hidden">
                    <div class="px-6 py-4 border-b border-gray-100 bg-emerald-50 flex justify-between items-center">
                        <h3 class="font-bold text-slate-800 flex items-center gap-2 text-sm"><i class="fas fa-keyboard text-emerald-600"></i> B. INPUT MANUAL (SATU PER SATU)</h3>
                    </div>
                    <div class="p-6">
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
                            <div><label class="text-[10px] font-bold text-slate-500 block mb-1">NO DN</label><input id="man-dn" class="form-input"></div>
                            <div><label class="text-[10px] font-bold text-slate-500 block">CUSTOMER</label><input id="man-cust" class="form-input"></div>
                            <div><label class="text-[10px] font-bold text-slate-500 block">KOTA</label><input id="man-kota" class="form-input"></div>
                            <div><label class="text-[10px] font-bold text-slate-500 block">QTY (TON)</label><input type="number" id="man-qty" class="form-input"></div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                            <div><label class="text-[10px] font-bold text-slate-500 block mb-1">JENIS UNIT</label><input id="man-unit" class="form-input"></div>
                            <div><label class="text-[10px] font-bold text-slate-500 block">VENDOR</label><input id="man-vendor" class="form-input"></div>
                            <div><label class="text-[10px] font-bold text-slate-500 block">NOPOL</label><input id="man-nopol" class="form-input"></div>
                            <div><label class="text-[10px] font-bold text-slate-500 block">DRIVER</label><input id="man-driver" class="form-input"></div>
                        </div>
                        <div class="flex justify-end gap-3">
                            <button onclick="showPage('dashboard')" class="px-5 py-2 rounded-lg text-xs font-bold text-slate-500 hover:bg-slate-200 transition uppercase">BATAL</button>
                            <button onclick="saveManual()" class="px-6 py-2 rounded-lg text-xs font-bold text-white bg-emerald-600 hover:bg-emerald-700 shadow-lg transition uppercase flex items-center gap-2">
                                <i class="fas fa-save"></i> SIMPAN DATA MANUAL
                            </button>
                        </div>
                    </div>
                </div>

            </div>

        </div>
    </main>

    <div class="copyright-footer">
        2026 Copy Right Ahmad Fauzi - DockPlan System - ALL RIGHTS RESERVED
    </div>

    <div id="login-screen" class="fixed inset-0 bg-[#0f172a] z-[100] flex items-center justify-center transition-all duration-500 hidden">
        <div class="bg-white p-8 rounded-2xl shadow-2xl w-96 border border-slate-600 text-center">
            <div class="w-16 h-16 bg-blue-600 rounded-xl flex items-center justify-center mx-auto mb-4 shadow-lg shadow-blue-500/50">
                <i class="fas fa-key text-white text-2xl"></i>
            </div>
            <h2 class="text-2xl font-black text-slate-800 mb-1 tracking-tight">DOCKPLAN SYSTEM</h2>
            <p class="text-[10px] font-bold text-slate-400 mb-6 uppercase tracking-widest">Silakan Login</p>
            
            <div class="space-y-4 text-left">
                <div>
                    <label class="text-[10px] font-bold text-slate-500 ml-1">USERNAME</label>
                    <input type="text" id="username-input" class="w-full p-3 bg-slate-100 border border-slate-300 rounded-lg text-xs font-bold focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Masukkan Username">
                </div>
                <div>
                    <label class="text-[10px] font-bold text-slate-500 ml-1">PASSWORD</label>
                    <input type="password" id="password-input" class="w-full p-3 bg-slate-100 border border-slate-300 rounded-lg text-xs font-bold focus:ring-2 focus:ring-blue-500 outline-none" placeholder="******">
                </div>
                <button onclick="prosesLogin()" class="w-full py-3 bg-slate-800 text-white rounded-lg font-bold text-sm hover:bg-slate-900 transition shadow-lg flex items-center justify-center gap-2">
                    <i class="fas fa-sign-in-alt"></i> MASUK
                </button>
            </div>
            <p class="mt-6 text-[10px] text-slate-400 font-bold">INDAH KIAT KARAWANG - 2026</p>
        </div>
    </div>

    <script>
    // --- 1. KONEKSI FIREBASE (Pastikan Script Library 3 baris di atas TETAP ADA) ---
    const firebaseConfig = {
      apiKey: "AIzaSyCHs4mqUYjDvdWH-HU0E6PGWsUu4yJG-kk",
      authDomain: "dockplan-system.firebaseapp.com",
      projectId: "dockplan-system",
      storageBucket: "dockplan-system.firebasestorage.app",
      messagingSenderId: "487876305197",
      appId: "1:487876305197:web:9a1d642d00f0bdf52fb3a4"
    };

    if (typeof firebase === 'undefined') {
        alert("ERROR: Script Firebase Library belum dimuat di bagian paling atas!");
    } else {
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    }
    
    const db = firebase.firestore();
    const auth = firebase.auth();

    // --- 2. VARIABEL GLOBAL ---
    let localData = []; 
    let USER_ROLE = ''; 
    let USER_NAME = ''; 

    // --- 3. SISTEM LOGIN (ANTI BLOKIR) ---
    function prosesLogin() {
        // 1. Ambil input & ubah ke huruf kecil (solusi capslock)
        const email = document.getElementById('username-input').value.trim().toLowerCase();
        const pass = document.getElementById('password-input').value.trim();

        if (!email || !pass) { alert('Harap isi Email dan Password!'); return; }

        // 2. Ubah tombol jadi Loading
        const btnLogin = document.querySelector('button[onclick="prosesLogin()"]');
        const textAsli = btnLogin.innerHTML;
        btnLogin.innerHTML = 'MOHON TUNGGU...';
        btnLogin.disabled = true;

        // 3. Proses ke Firebase
        auth.signInWithEmailAndPassword(email, pass)
            .then((cred) => {
                return db.collection('users').doc(email).get();
            })
            .then((doc) => {
                if (doc.exists) {
                    const data = doc.data();

                    // --- [PENTING!] SIMPAN SESI BARU ---
                    // Ini akan menimpa data 'Silog' yang nyangkut dengan data user yang baru login
                    localStorage.setItem('dockplan_session', JSON.stringify(data));

                    masukAplikasi(data.role, data.nama);
                    alert(`Login Berhasil!\nSelamat Datang, ${data.nama}`); 
                } else {
                    alert('GAGAL: Email benar, tapi belum disetup. KLIK TOMBOL MERAH DI POJOK KIRI BAWAH DULU!');
                    auth.signOut();
                }
            })
            .catch((err) => {
                let msg = err.message;
                if(err.code === 'auth/invalid-credential') msg = "Password atau Email Salah.";
                alert('Login Gagal: ' + msg);
            })
            .finally(() => {
                btnLogin.innerHTML = textAsli;
                btnLogin.disabled = false;
            });
    }

    // Penjaga Pintu Otomatis
    auth.onAuthStateChanged((user) => {
        if (user) {
            db.collection('users').doc(user.email).get().then((doc) => {
                if(doc.exists) {
                    const d = doc.data();
                    masukAplikasi(d.role, d.nama);
                }
            });
        } else {
            document.getElementById('login-screen').classList.remove('hidden');
        }
    });

    function masukAplikasi(role, nama) {
        USER_ROLE = role;
        USER_NAME = nama.toUpperCase(); 

        document.getElementById('login-screen').classList.add('hidden');
        const subtitle = document.getElementById('page-subtitle');
        if(subtitle) subtitle.innerText = `${nama} (${role})`;

        // Sembunyikan Tombol Setup jika sudah login
        const btnSetup = document.getElementById('btn-setup-darurat');
        if(btnSetup) btnSetup.style.display = 'none';

        // ATUR MENU
        const btnInput = document.getElementById('menu-input');
        const btnDelete = document.getElementById('btn-delete-bulk');
        const btnReset = document.querySelector('button[onclick="resetData()"]');
        
        if (role === 'ADMIN') {
            if(btnInput) btnInput.style.display = 'flex';
            if(btnDelete) btnDelete.style.display = 'flex';
            if(btnReset) btnReset.style.display = 'flex';
        } else {
            if(btnInput) btnInput.style.display = 'none';
            if(btnDelete) btnDelete.style.display = 'none';
            if(btnReset) btnReset.style.display = 'none';
        }

        renderTable();
        updateStats();
    }

    function logout() {
        if (confirm("Yakin ingin keluar?")) {
            // TAMBAHKAN BARIS INI: Hapus data sesi dari memori browser
            localStorage.removeItem('dockplan_session'); 
            
            auth.signOut().then(() => location.reload());
        }
    }

    // --- 4. RENDER TABLE & LOGIC ---
    db.collection("bookings").orderBy("created", "desc").onSnapshot((snapshot) => {
        localData = [];
        snapshot.forEach((doc) => {
            let d = doc.data();
            d.id = doc.id;
            localData.push(d);
        });
        renderTable();
        updateStats(); // Panggil updateStats yg sudah diperbaiki
    });

    function renderTable() {
        let dataTampil = localData;
        const filter = document.getElementById('searchInput').value.toUpperCase();

        if (USER_ROLE === 'VENDOR') {
            dataTampil = dataTampil.filter(item => item.vendor && item.vendor.toUpperCase() === USER_NAME);
        } 
        else if (USER_ROLE === 'CUSTOMER') {
            dataTampil = dataTampil.filter(item => item.customer && item.customer.toUpperCase() === USER_NAME);
        }

        if(filter) dataTampil = dataTampil.filter(i => JSON.stringify(i).toUpperCase().includes(filter));

        const tbody = document.getElementById('table-body');
        const mobileView = document.getElementById('mobile-view');
        tbody.innerHTML = ''; mobileView.innerHTML = '';

        if(dataTampil.length === 0) {
            tbody.innerHTML = `<tr><td colspan="13" class="text-center py-10 font-bold text-slate-400">DATA TIDAK DITEMUKAN / ANDA BELUM PUNYA DATA</td></tr>`;
            mobileView.innerHTML = `<div class="text-center py-10 text-slate-400 font-bold italic">DATA TIDAK DITEMUKAN</div>`;
            return;
        }

        dataTampil.forEach((item, idx) => {
            const dCreated = new Date(item.created);
            const showCreated = `${dCreated.getDate()}/${dCreated.getMonth()+1} ${String(dCreated.getHours()).padStart(2,'0')}:${String(dCreated.getMinutes()).padStart(2,'0')}`;
            
            const formatJadwal = (val) => {
                if(!val) return '<span class="status-waiting text-red-500 font-bold text-[9px]">MENUNGGU<br>KONFIRMASI</span>';
                const d = new Date(val);
                const months = ["JAN", "FEB", "MAR", "APR", "MEI", "JUN", "JUL", "AGU", "SEP", "OKT", "NOV", "DES"];
                return `<div class="text-blue-800 text-[11px] font-bold"><i class="fas fa-calendar-alt mr-1"></i>${d.getDate()} ${months[d.getMonth()]}</div>`;
            };

            const row = `
            <tr class="border-b hover:bg-slate-50 transition">
                <td><input type="checkbox" class="row-chk" value="${item.id}"></td>
                <td class="text-center font-bold text-slate-500">${idx+1}</td>
                <td class="text-center text-[10px] font-bold text-slate-400">${showCreated}</td>
                <td class="font-bold text-blue-800 text-[10px]">${item.dn}</td>
                <td class="font-bold text-slate-700 text-[10px]">${item.customer}</td>
                <td class="text-center font-bold text-slate-600 text-[10px]">${item.kota}</td>
                <td class="text-center font-black text-slate-800">${item.qty}</td>
                <td class="text-center font-bold text-slate-600 text-[10px]">${item.unit}</td>
                <td class="text-center font-bold text-slate-600 text-[10px]">${item.vendor || '-'}</td>
                <td class="bg-slate-50 px-2">
                    <div class="font-black text-slate-800 text-[11px] border-b border-slate-200 pb-1">${item.nopol || '-'}</div>
                    <div class="font-bold text-slate-500 text-[9px]">${item.driver || '-'}</div>
                </td>
                <td class="text-center bg-yellow-50 border-x border-slate-200">${formatJadwal(item.stuffing)}</td>
                <td class="text-center bg-green-50 border-r border-slate-200">${formatJadwal(item.bongkar)}</td>
                <td class="text-center">
                    <button onclick="editItem('${item.id}')" class="text-blue-600 hover:bg-blue-100 p-2 rounded transition"><i class="fas fa-edit"></i></button>
                </td>
            </tr>`;
            tbody.innerHTML += row;

            const card = `
            <div class="bg-white p-4 rounded-xl shadow border border-slate-200 mb-3">
                <div class="flex justify-between items-start border-b pb-2 mb-2">
                    <div>
                        <h4 class="font-black text-blue-700">${item.dn}</h4>
                        <div class="text-[10px] font-bold text-slate-500">${item.customer}</div>
                    </div>
                    <div class="text-right">
                        <div class="font-black text-lg">${item.qty}</div>
                        <div class="text-[8px] font-bold text-slate-400">TON</div>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-2 mb-2 text-[10px]">
                    <div class="bg-slate-50 p-2 rounded">
                        <span class="block text-slate-400 font-bold">VENDOR</span>
                        <b class="text-slate-700">${item.vendor || '-'}</b>
                    </div>
                    <div class="bg-slate-50 p-2 rounded">
                        <span class="block text-slate-400 font-bold">DRIVER</span>
                        <b class="text-slate-700">${item.driver || '-'} / ${item.nopol || '-'}</b>
                    </div>
                </div>
                <button onclick="editItem('${item.id}')" class="w-full py-2 bg-blue-600 text-white rounded font-bold text-xs shadow">EDIT DATA</button>
            </div>`;
            mobileView.innerHTML += card;
        });
    }

    // --- 5. EDIT LOGIC ---
    function editItem(id) {
        const item = localData.find(i => i.id === id); if(!item) return;

        document.getElementById('edit-id').value = id;
        document.getElementById('edit-dn').value = item.dn;
        document.getElementById('edit-cust').value = item.customer;
        document.getElementById('edit-unit').value = item.unit;
        document.getElementById('edit-qty').value = item.qty;
        document.getElementById('edit-kota').value = item.kota;
        document.getElementById('edit-vendor').value = item.vendor;
        document.getElementById('edit-nopol').value = item.nopol;
        document.getElementById('edit-driver').value = item.driver;
        document.getElementById('edit-stuffing').value = item.stuffing;
        document.getElementById('edit-bongkar').value = item.bongkar;

        const allFields = ['edit-dn','edit-cust','edit-unit','edit-qty','edit-kota','edit-vendor','edit-nopol','edit-driver','edit-stuffing','edit-bongkar'];
        allFields.forEach(f => {
            const el = document.getElementById(f); el.disabled = true; el.style.backgroundColor = '#f1f5f9'; 
        });

        if (USER_ROLE === 'ADMIN') {
            allFields.forEach(f => { document.getElementById(f).disabled = false; document.getElementById(f).style.backgroundColor = 'white'; });
        }
        else if (USER_ROLE === 'VENDOR') {
            ['edit-nopol', 'edit-driver'].forEach(f => {
                const el = document.getElementById(f); el.disabled = false; el.style.backgroundColor = 'white'; el.style.border = '2px solid #3b82f6'; 
            });
        }
        else if (USER_ROLE === 'CUSTOMER') {
            ['edit-bongkar'].forEach(f => {
                const el = document.getElementById(f); el.disabled = false; el.style.backgroundColor = 'white'; el.style.border = '2px solid #22c55e';
            });
        }
        document.getElementById('modal-edit').style.display = 'flex';
    }

    function simpanPerubahan() {
        const id = document.getElementById('edit-id').value;
        const updates = {};

        if (USER_ROLE === 'ADMIN') {
            updates.dn = document.getElementById('edit-dn').value.toUpperCase();
            updates.customer = document.getElementById('edit-cust').value.toUpperCase();
            updates.unit = document.getElementById('edit-unit').value.toUpperCase();
            updates.qty = document.getElementById('edit-qty').value;
            updates.kota = document.getElementById('edit-kota').value.toUpperCase();
            updates.vendor = document.getElementById('edit-vendor').value.toUpperCase();
            updates.nopol = document.getElementById('edit-nopol').value.toUpperCase();
            updates.driver = document.getElementById('edit-driver').value.toUpperCase();
            updates.stuffing = document.getElementById('edit-stuffing').value;
            updates.bongkar = document.getElementById('edit-bongkar').value;
        } 
        else if (USER_ROLE === 'VENDOR') {
            updates.nopol = document.getElementById('edit-nopol').value.toUpperCase();
            updates.driver = document.getElementById('edit-driver').value.toUpperCase();
        } 
        else if (USER_ROLE === 'CUSTOMER') {
            updates.bongkar = document.getElementById('edit-bongkar').value;
        }

        db.collection("bookings").doc(id).update(updates)
            .then(() => { alert('Berhasil Update!'); tutupModal(); })
            .catch((err) => { alert('Gagal: ' + err.message); });
    }

    function tutupModal() { document.getElementById('modal-edit').style.display = 'none'; }
    function resetData() { alert('Fitur reset hanya untuk Admin.'); }
    
    // --- PERBAIKAN: Update Stats Tanpa getDB() ---
    // --- FUNGSI UPDATE STATISTIK (VERSI FINAL & BENAR) ---
    function updateStats() {
        // 1. Ambil data mentah dari localData (bukan getDB)
        let dataHitung = localData;

        // 2. FILTER DATA (Agar statistik sesuai dengan siapa yang login)
        // Kalau Vendor login, hitung data dia saja. Kalau Admin, hitung semua.
        if (USER_ROLE === 'VENDOR') {
            dataHitung = dataHitung.filter(item => item.vendor && item.vendor.toUpperCase() === USER_NAME);
        } 
        else if (USER_ROLE === 'CUSTOMER') {
            dataHitung = dataHitung.filter(item => item.customer && item.customer.toUpperCase() === USER_NAME);
        }

        // 3. MULAI MENGHITUNG
        const total = dataHitung.length;
        
        // Dihitung "Confirmed" jika Tanggal Stuffing DAN Bongkar sudah diisi
        const confirmed = dataHitung.filter(i => i.stuffing && i.bongkar).length;
        
        // Sisanya adalah Pending
        const pending = total - confirmed;

        // 4. TAMPILKAN KE LAYAR (Update Angka di Kotak Atas)
        if(document.getElementById('stat-total')) document.getElementById('stat-total').innerText = total;
        if(document.getElementById('stat-pending')) document.getElementById('stat-pending').innerText = pending;
        if(document.getElementById('stat-confirmed')) document.getElementById('stat-confirmed').innerText = confirmed;
    }

        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('collapsed');
            document.getElementById('main-content').classList.toggle('expanded');
        }

        window.showPage = function(pageId) {
            document.getElementById('view-dashboard').classList.add('hidden');
            document.getElementById('view-input').classList.add('hidden');
            document.getElementById('menu-dashboard').classList.remove('active');
            document.getElementById('menu-input').classList.remove('active');
            
            document.getElementById(`view-${pageId}`).classList.remove('hidden');
            document.getElementById(`menu-${pageId}`).classList.add('active');
            
            if(pageId === 'dashboard') {
                document.getElementById('page-subtitle').innerText = 'MONITORING OVERVIEW';
                renderTable();
                updateStats();
            } else {
                document.getElementById('page-subtitle').innerText = 'DATA ENTRY';
                // Reset Fields
                document.getElementById('input-vendor-batch').value = ''; 
                document.getElementById('paste-area').value = '';
            }
        }

        // --- CHECKBOX LOGIC ---
        window.toggleSelectAll = function() {
            const isChecked = document.getElementById('checkAll').checked;
            document.querySelectorAll('.row-chk').forEach(cb => cb.checked = isChecked);
            updateDeleteButton();
        }

        window.updateDeleteButton = function() {
            const checkedCount = document.querySelectorAll('.row-chk:checked').length;
            document.getElementById('selected-count').innerText = checkedCount;
            document.getElementById('btn-delete-bulk').disabled = checkedCount === 0;
        }

        // --- FITUR HAPUS DATA (VERSI GOOGLE FIREBASE) ---
        window.deleteSelected = function() {
    // 1. Ambil semua kotak yang dicentang
    const checkboxes = document.querySelectorAll('.row-chk:checked');
    
    // Kalau tidak ada yang dicentang, stop
    if(checkboxes.length === 0) return;

    // 2. Konfirmasi Hapus menggunakan window.confirm (Anti-Blokir)
    if (confirm(`Hapus ${checkboxes.length} Data?\nData akan hilang selamanya dari server Google!`)) {
        
        // Karena Swal (Loading) tidak bisa jalan, kita beri log di console
        console.log("Sedang menghapus data...");

        const batch = db.batch(); // Pakai mode "Batch" biar cepat
        
        checkboxes.forEach((cb) => {
            const docId = cb.value; // Ambil ID unik dari Google
            const docRef = db.collection("bookings").doc(docId);
            batch.delete(docRef);
        });

        // 3. Eksekusi Hapus
        batch.commit().then(() => {
            // Sukses - Menggunakan alert bawaan
            alert("Data berhasil dihapus.");
            document.getElementById('checkAll').checked = false;
            updateDeleteButton(); // Matikan tombol hapus
        }).catch((error) => {
            // Gagal
            console.error("Gagal hapus:", error);
            alert("Error: Gagal menghapus data: " + error.message);
        });
    }
}

        // --- EXPORT EXCEL ---
        window.exportToExcel = function() {
            let db = getDB();
            if(db.length === 0) { Swal.fire('Data Kosong', 'Tidak ada data untuk diexport', 'warning'); return; }

            let csvContent = "data:text/csv;charset=utf-8,";
            csvContent += "NO,CREATED,DN,CUSTOMER,KOTA,QTY,UNIT,VENDOR,NOPOL,DRIVER,TGL STUFFING,TGL BONGKAR\n";
            
            db.forEach((item, index) => {
                const created = new Date(item.created).toLocaleDateString('id-ID');
                const cust = item.customer.replace(/,/g, " ");
                const row = [
                    index + 1,
                    created,
                    `'${item.dn}`,
                    cust,
                    item.kota,
                    item.qty,
                    item.unit,
                    item.vendor,
                    item.nopol,
                    item.driver,
                    item.stuffing || '-',
                    item.bongkar || '-'
                ].join(",");
                csvContent += row + "\n";
            });

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `DOCKPLAN_DATA_${new Date().getTime()}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // --- INPUT MANUAL LOGIC ---
        function saveManual() {
        const dn = document.getElementById('man-dn').value.toUpperCase();
        const cust = document.getElementById('man-cust').value.toUpperCase();
        
        if(!dn || !cust) {
            Swal.fire('Data Kurang', 'No DN dan Customer Wajib Diisi', 'warning');
            return;
        }

        // 1. LANGSUNG KIRIM KE GOOGLE (Tanpa Loading)
        db.collection("bookings").add({
            created: new Date().toISOString(),
            dn: dn,
            customer: cust,
            kota: document.getElementById('man-kota').value.toUpperCase(),
            qty: parseFloat(document.getElementById('man-qty').value) || 0,
            unit: document.getElementById('man-unit').value.toUpperCase(),
            vendor: document.getElementById('man-vendor').value.toUpperCase(),
            nopol: document.getElementById('man-nopol').value.toUpperCase(),
            driver: document.getElementById('man-driver').value.toUpperCase(),
            stuffing: '', 
            bongkar: '', 
            isGb: false
        }).catch((error) => {
            // Kalau error baru muncul notif (tapi jarang terjadi)
            console.error("Gagal simpan:", error);
            Swal.fire('Error', 'Koneksi bermasalah, data mungkin tidak tersimpan.', 'error');
        });

        // 2. LANGSUNG BERSIHKAN FORM DETIK ITU JUGA
        ['man-dn','man-cust','man-kota','man-qty','man-unit','man-vendor','man-nopol','man-driver'].forEach(id => document.getElementById(id).value = '');

        // 3. LANGSUNG PINDAH HALAMAN
        // Muncul notif kecil saja di pojok (Toast) biar tidak mengganggu
        const Toast = Swal.mixin({
            toast: true, position: 'top-end', showConfirmButton: false, timer: 1500, timerProgressBar: true
        });
        Toast.fire({ icon: 'success', title: 'Data diproses...' });
        
        showPage('dashboard');
    }

        // --- SAP PROCESSING ---
        function processPaste() {
    const rawText = document.getElementById('paste-area').value;
    const vendorBatch = document.getElementById('input-vendor-batch').value.toUpperCase().trim();
    const unitBatch = document.getElementById('input-unit-batch').value.toUpperCase().trim();
    const inputTime = new Date().toISOString();

    // Ganti Swal.fire dengan alert biasa
    if(!rawText.trim()) { 
        alert('Data Kosong: Silakan paste data dulu');
        return; 
    }

    // --- PARSING DATA ---
    const lines = rawText.trim().split('\n');
    const groupedData = {};
    let singleDataList = [];

    lines.forEach((line, index) => {
        if(!line.trim()) return;
        const cols = line.split('\t').map(c => c.trim()).filter(c => c !== '');
        if(cols.length < 7) return;

        const dn = cols[1];
        const customer = cols[3];
        const kota = cols[4];
        let qtyRaw = cols[5].replace(/,/g, '');
        let qty = parseFloat(qtyRaw);
        let cleanUnit = unitBatch || '-';
        if(!unitBatch && cols[7]) cleanUnit = cols[7].split(/[ ;.,]/)[0].toUpperCase();

        const gbMatch = line.toUpperCase().match(/GB\s*(\d+)/);
        
        const entry = {
            created: inputTime,
            dn: dn,
            customer: customer,
            kota: kota,
            qty: qty, 
            unit: cleanUnit,
            vendor: vendorBatch || '', 
            nopol: '', driver: '', stuffing: '', bongkar: '',
            isGb: false
        };

        if (gbMatch) {
            const gbCode = "GB" + gbMatch[1];
            if (!groupedData[gbCode]) {
                groupedData[gbCode] = { ...entry };
                groupedData[gbCode].dn = [entry.dn];
            } else {
                groupedData[gbCode].qty += entry.qty;
                if (!groupedData[gbCode].dn.includes(entry.dn)) {
                    groupedData[gbCode].dn.push(entry.dn);
                }
            }
        } else {
            singleDataList.push(entry);
        }
    });

    const finalMergedList = [];
    for (const key in groupedData) {
        const item = groupedData[key];
        item.dn = item.dn.join(', ');
        finalMergedList.push(item);
    }
    const allNewData = [...finalMergedList, ...singleDataList];

    // --- UPLOAD BACKGROUND ---
    if(allNewData.length > 0) {
        const batch = db.batch();
        allNewData.forEach((item) => {
            const docRef = db.collection("bookings").doc();
            batch.set(docRef, item);
        });

        batch.commit()
            .then(() => {
                console.log("Upload berhasil ke Firebase.");
            })
            .catch(err => {
                console.error("Gagal batch:", err);
                alert("Gagal mengirim data ke server: " + err.message);
            });

        // LANGSUNG PINDAH TAMPILAN
        document.getElementById('paste-area').value = '';
        document.getElementById('input-vendor-batch').value = '';
        
        // Ganti Toast Swal dengan alert sederhana
        alert(`${allNewData.length} Data berhasil diproses ke server.`);

        showPage('dashboard');

    } else {
        alert('Gagal: Format data tidak sesuai.');
    }
}

        // --- RENDER TABLE ---
        // --- FUNGSI RENDER TABEL (VERSI FIX TOMBOL EDIT) ---
        // --- MODIFIKASI FUNGSI RENDER (TABLE & MOBILE CARD) ---
function renderTable() {
    // Ambil text pencarian
    const filter = document.getElementById('searchInput').value.toUpperCase();
    
    // 1. Ambil data dari penampung lokal
    let db = localData;

    // --- FILTER ROLE ---
    if (USER_ROLE === 'CUSTOMER') {
        db = db.filter(item => item.customer && item.customer.includes(USER_NAME));
    } 
    else if (USER_ROLE === 'VENDOR') {
        db = db.filter(item => item.vendor && item.vendor.includes(USER_NAME));
    }

    // 2. Logika Filter Pencarian
    if(filter) {
        db = db.filter(i => 
            (i.dn && i.dn.includes(filter)) || 
            (i.customer && i.customer.toUpperCase().includes(filter)) ||
            (i.kota && i.kota.toUpperCase().includes(filter)) ||
            (i.unit && i.unit.toUpperCase().includes(filter)) ||
            (i.vendor && i.vendor.toUpperCase().includes(filter)) ||
            (i.nopol && i.nopol.toUpperCase().includes(filter)) ||
            (i.driver && i.driver.toUpperCase().includes(filter))
        );
    }

    // SIAPKAN DUA WADAH: TABLE (PC) DAN CARD (HP)
    const tbody = document.getElementById('table-body');
    const mobileView = document.getElementById('mobile-view');
    
    tbody.innerHTML = '';
    mobileView.innerHTML = ''; // Bersihkan tampilan HP
    
    document.getElementById('checkAll').checked = false;
    updateDeleteButton();

    // Jika Data Kosong
    if(db.length === 0) {
        tbody.innerHTML = `<tr><td colspan="13" class="py-16 text-slate-400 italic font-bold">DATA KOSONG / TIDAK DITEMUKAN</td></tr>`;
        mobileView.innerHTML = `<div class="text-center py-10 text-slate-400 font-bold italic">DATA TIDAK DITEMUKAN</div>`;
        return;
    }

    // Loop Data
    db.forEach((item, idx) => {
        const dCreated = new Date(item.created);
        const showCreated = `${dCreated.getDate()}/${dCreated.getMonth()+1} ${String(dCreated.getHours()).padStart(2,'0')}:${String(dCreated.getMinutes()).padStart(2,'0')}`;

        const formatJadwal = (val) => {
            if(!val) return '<span class="status-waiting">MENUNGGU<br>KONFIRMASI</span>';
            const d = new Date(val);
            const months = ["JAN", "FEB", "MAR", "APR", "MEI", "JUN", "JUL", "AGU", "SEP", "OKT", "NOV", "DES"];
            return `<div class="text-blue-800 text-[11px] font-bold"><i class="fas fa-calendar-alt mr-1"></i>${d.getDate()} ${months[d.getMonth()]}</div>`;
        };

        const displayQty = Math.round(item.qty).toLocaleString('id-ID');

        // --- A. RENDER TABEL (UNTUK PC) ---
        const row = `
            <tr class="transition group border-b border-slate-300 hover:bg-slate-100">
                <td><input type="checkbox" class="row-chk" value="${item.id}" onclick="updateDeleteButton()"></td>
                <td class="bg-slate-50 font-bold text-slate-500">${idx + 1}</td>
                <td class="font-bold text-slate-600 bg-slate-50 text-[9px] leading-tight">${showCreated}</td>
                <td class="font-bold text-blue-700 break-words text-[10px] leading-tight">${item.dn}</td>
                <td class="font-bold text-slate-700 leading-tight">${item.customer}</td>
                <td class="text-slate-600 font-bold">${item.kota}</td>
                <td class="font-black text-slate-700 bg-slate-50">${displayQty}</td>
                <td class="font-bold text-slate-700">${item.unit}</td>
                <td class="font-bold text-slate-600">${item.vendor || '-'}</td>
                
                <td class="bg-slate-50">
                    <div class="font-black text-slate-800 border-b border-slate-300 pb-1 mb-1">${item.nopol || '-'}</div>
                    <div class="font-bold text-slate-500 text-[9px]">${item.driver || '-'}</div>
                </td>

                <td class="bg-yellow-50 border-x border-slate-300">${formatJadwal(item.stuffing)}</td>
                <td class="bg-green-50 border-r border-slate-300">${formatJadwal(item.bongkar)}</td>
                <td>
                    <div class="flex justify-center gap-1">
                        <button onclick="editItem('${item.id}')" class="text-blue-600 hover:text-blue-800 p-2 rounded hover:bg-blue-100 transition">
                            <i class="fas fa-edit"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `;
        tbody.innerHTML += row;

        // --- B. RENDER KARTU (UNTUK HP) ---
        // Desain Kartu Mobile agar mudah diedit
        const card = `
            <div class="bg-white p-5 rounded-xl shadow-lg border border-slate-200 relative">
                <div class="flex justify-between items-start mb-3 pb-3 border-b border-slate-100">
                    <div>
                        <div class="flex items-center gap-2 mb-1">
                            <span class="bg-slate-800 text-white text-[9px] px-2 py-0.5 rounded font-bold">#${idx + 1}</span>
                            <span class="text-[9px] text-slate-400 font-bold">${showCreated}</span>
                        </div>
                        <h4 class="text-lg font-black text-blue-700 leading-none mb-1">${item.dn}</h4>
                        <div class="text-xs font-bold text-slate-700 uppercase">${item.customer}</div>
                        <div class="text-[10px] text-slate-500 font-bold"><i class="fas fa-map-marker-alt text-red-500"></i> ${item.kota}</div>
                    </div>
                    <div class="text-right">
                         <div class="text-2xl font-black text-slate-800">${displayQty}</div>
                         <div class="text-[9px] font-bold text-slate-400 uppercase">TON</div>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-3 mb-4">
                    <div class="bg-slate-50 p-2 rounded border border-slate-100">
                        <div class="text-[9px] text-slate-400 font-bold mb-1">UNIT & VENDOR</div>
                        <div class="font-bold text-slate-700 text-xs">${item.unit}</div>
                        <div class="font-bold text-blue-600 text-[10px] truncate">${item.vendor || '-'}</div>
                    </div>
                    <div class="bg-slate-50 p-2 rounded border border-slate-100">
                        <div class="text-[9px] text-slate-400 font-bold mb-1">DRIVER INFO</div>
                        <div class="font-bold text-slate-800 text-xs">${item.nopol || '-'}</div>
                        <div class="font-bold text-slate-500 text-[10px] truncate">${item.driver || '-'}</div>
                    </div>
                </div>

                <div class="flex gap-2 mb-4">
                    <div class="flex-1 bg-yellow-50 p-2 rounded border border-yellow-100 text-center">
                        <div class="text-[9px] font-bold text-yellow-700 mb-1">STUFFING</div>
                        ${formatJadwal(item.stuffing)}
                    </div>
                    <div class="flex-1 bg-green-50 p-2 rounded border border-green-100 text-center">
                        <div class="text-[9px] font-bold text-green-700 mb-1">BONGKAR</div>
                        ${formatJadwal(item.bongkar)}
                    </div>
                </div>

                <div class="flex justify-between items-center pt-2">
                    <label class="flex items-center gap-2 p-2 rounded hover:bg-slate-50 cursor-pointer">
                        <input type="checkbox" class="row-chk w-5 h-5 accent-blue-600" value="${item.id}" onclick="updateDeleteButton()">
                        <span class="text-[10px] font-bold text-slate-500">PILIH ITEM</span>
                    </label>

                    <button onclick="editItem('${item.id}')" class="bg-blue-600 text-white px-6 py-2 rounded-lg text-xs font-bold hover:bg-blue-700 shadow-lg shadow-blue-500/30 flex items-center gap-2">
                        <i class="fas fa-edit"></i> EDIT DATA
                    </button>
                </div>
            </div>
        `;
        mobileView.innerHTML += card;
    });
}

        // --- FITUR EDIT DATA (VERSI GOOGLE FIREBASE) ---
        // --- FITUR EDIT PINTAR (SESUAI LOGIN) ---
    // --- FUNGSI BUKA MODAL EDIT ---
function editItem(id) {
    const item = localData.find(i => i.id === id);
    if (!item) return;

    // 1. Isi Form dengan Data Lama
    document.getElementById('edit-id').value = id;
    document.getElementById('edit-dn').value = item.dn;
    document.getElementById('edit-cust').value = item.customer;
    document.getElementById('edit-unit').value = item.unit;
    document.getElementById('edit-qty').value = item.qty;
    document.getElementById('edit-kota').value = item.kota;
    document.getElementById('edit-vendor').value = item.vendor;
    document.getElementById('edit-nopol').value = item.nopol;
    document.getElementById('edit-driver').value = item.driver;
    document.getElementById('edit-stuffing').value = item.stuffing;
    document.getElementById('edit-bongkar').value = item.bongkar;

    // 2. ATUR PERIZINAN (Siapa Boleh Edit Apa)
    // Default: Matikan Semua Dulu
    const allInputs = ['edit-dn','edit-cust','edit-unit','edit-qty','edit-kota','edit-vendor','edit-nopol','edit-driver','edit-stuffing','edit-bongkar'];
    allInputs.forEach(id => {
        document.getElementById(id).disabled = true;
        document.getElementById(id).style.backgroundColor = "#f1f5f9"; // Warna abu-abu
    });

    // Cek Role
    if (USER_ROLE === 'ADMIN') {
        // ADMIN: Buka Semua
        allInputs.forEach(id => {
            document.getElementById(id).disabled = false;
            document.getElementById(id).style.backgroundColor = "white";
        });
    } 
    else if (USER_ROLE === 'VENDOR') {
        // VENDOR: Hanya Nopol & Driver
        ['edit-nopol', 'edit-driver'].forEach(id => {
            document.getElementById(id).disabled = false;
            document.getElementById(id).style.backgroundColor = "white";
            document.getElementById(id).style.border = "2px solid #3b82f6"; // Highlight Biru
        });
    } 
    else if (USER_ROLE === 'CUSTOMER') {
        // CUSTOMER: Hanya Tanggal Bongkar
        ['edit-bongkar'].forEach(id => {
            document.getElementById(id).disabled = false;
            document.getElementById(id).style.backgroundColor = "white";
            document.getElementById(id).style.border = "2px solid #22c55e"; // Highlight Hijau
        });
    }

    // 3. Tampilkan Modal
    document.getElementById('modal-edit').style.display = 'flex';
}

// --- FUNGSI TUTUP MODAL ---
function tutupModal() {
    document.getElementById('modal-edit').style.display = 'none';
}

// --- FUNGSI SIMPAN KE FIREBASE ---
function simpanPerubahan() {
    const id = document.getElementById('edit-id').value;
    
    // Ambil data dari form
    const updates = {
        dn: document.getElementById('edit-dn').value.toUpperCase(),
        customer: document.getElementById('edit-cust').value.toUpperCase(),
        unit: document.getElementById('edit-unit').value.toUpperCase(),
        qty: parseFloat(document.getElementById('edit-qty').value) || 0,
        kota: document.getElementById('edit-kota').value.toUpperCase(),
        vendor: document.getElementById('edit-vendor').value.toUpperCase(),
        nopol: document.getElementById('edit-nopol').value.toUpperCase(),
        driver: document.getElementById('edit-driver').value.toUpperCase(),
        stuffing: document.getElementById('edit-stuffing').value,
        bongkar: document.getElementById('edit-bongkar').value
    };

    // Filter: Jangan simpan field yang di-disabled (biar user nakal gak bisa hack via inspect element)
    // Tapi karena kita pakai firebase update, kita cukup percaya input yang enabled saja.
    // Untuk keamanan extra di sisi klien (Client Side):
    if (USER_ROLE === 'VENDOR') {
        // Hapus data yang bukan hak vendor dari objek update
        delete updates.dn; delete updates.customer; delete updates.unit; 
        delete updates.qty; delete updates.kota; delete updates.vendor; 
        delete updates.stuffing; delete updates.bongkar;
    }
    if (USER_ROLE === 'CUSTOMER') {
        // Hapus semua kecuali bongkar
        const bongkarSaja = { bongkar: updates.bongkar };
        // Timpa updates dengan objek baru
        // (Cara cepat: kita pakai object updates yg sudah ada tapi kita bersihkan isinya)
        // Agar aman, kita buat ulang variable updates untuk customer:
        db.collection("bookings").doc(id).update({ bongkar: updates.bongkar })
        .then(() => { alert("Jadwal Bongkar Terupdate!"); tutupModal(); })
        .catch((e) => alert("Error: " + e.message));
        return; 
    }

    // Eksekusi Simpan (Admin & Vendor & Generic)
    db.collection("bookings").doc(id).update(updates)
    .then(() => {
        alert("Data Berhasil Disimpan!");
        tutupModal();
    })
    .catch((error) => {
        alert("Gagal Simpan: " + error.message);
    });
}

        function resetData() {
        Swal.fire('Fitur Dimatikan', 'Demi keamanan data Cloud, tombol Reset Global dinonaktifkan.', 'info');
    }
        renderTable();
        // --- POINT 3: AUTO-LOGIN SAAT REFRESH ---
// Fungsi ini akan berjalan otomatis setiap kali halaman dimuat (onload)
// --- GABUNGAN: SETUP USER & AUTO LOGIN (PASTE DI PALING BAWAH) ---
// --- BAGIAN PALING BAWAH SCRIPT ---

window.addEventListener('load', function() {
    
    // BAGIAN TOMBOL SETUP SUDAH DIHAPUS AGAR TIDAK MENGGANGGU TAMPILAN
    
    // LOGIC AUTO LOGIN (CEK APAKAH USER MASIH LOGIN)
    const savedUser = localStorage.getItem('dockplan_session');
    
    if (savedUser) {
        // Jika ada sesi tersimpan, langsung masuk (Skip Login)
        try {
            const data = JSON.parse(savedUser);
            // Cek validitas data sedikit biar gak error
            if(data && data.role && data.nama) {
                console.log("Auto-login berhasil sebagai: " + data.nama);
                masukAplikasi(data.role, data.nama);
            } else {
                throw new Error("Data sesi rusak");
            }
        } catch (e) {
            // Jika data sesi rusak, hapus dan suruh login ulang
            localStorage.removeItem('dockplan_session');
            tampilkanLogin();
        }
    } else {
        // Jika tidak ada sesi, tampilkan layar login
        tampilkanLogin();
    }

    function tampilkanLogin() {
        const loginScreen = document.getElementById('login-screen');
        if(loginScreen) {
            loginScreen.classList.remove('hidden');
            loginScreen.classList.remove('opacity-0');
            loginScreen.classList.remove('pointer-events-none');
        }
    }
});
    </script>
    <div id="modal-edit" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999; align-items: center; justify-content: center;">
    <div style="background: white; padding: 20px; width: 90%; max-width: 500px; border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.3); max-height: 90vh; overflow-y: auto;">
        
        <h3 style="margin-bottom: 15px; font-weight: bold; border-bottom: 2px solid #eee; padding-bottom: 10px;">EDIT DATA</h3>
        
        <input type="hidden" id="edit-id">

        <div style="display: grid; gap: 10px;">
            <div>
                <label style="font-size: 10px; font-weight: bold; color: #666;">NO DN</label>
                <input type="text" id="edit-dn" class="form-input" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
            </div>
            <div>
                <label style="font-size: 10px; font-weight: bold; color: #666;">CUSTOMER</label>
                <input type="text" id="edit-cust" class="form-input" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <div>
                    <label style="font-size: 10px; font-weight: bold; color: #666;">UNIT</label>
                    <input type="text" id="edit-unit" class="form-input" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                </div>
                <div>
                    <label style="font-size: 10px; font-weight: bold; color: #666;">QTY</label>
                    <input type="number" id="edit-qty" class="form-input" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                </div>
            </div>
            <div>
                <label style="font-size: 10px; font-weight: bold; color: #666;">KOTA</label>
                <input type="text" id="edit-kota" class="form-input" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
            </div>

            <div style="background: #f0f9ff; padding: 10px; border-radius: 4px; border: 1px solid #bae6fd;">
                <label style="font-size: 10px; font-weight: bold; color: #0284c7; display: block; margin-bottom: 5px;">AREA VENDOR</label>
                <div>
                    <label style="font-size: 10px; font-weight: bold; color: #666;">VENDOR NAME</label>
                    <input type="text" id="edit-vendor" class="form-input" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; margin-bottom: 5px;">
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <div>
                        <label style="font-size: 10px; font-weight: bold; color: #666;">NOPOL</label>
                        <input type="text" id="edit-nopol" class="form-input" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                    </div>
                    <div>
                        <label style="font-size: 10px; font-weight: bold; color: #666;">DRIVER</label>
                        <input type="text" id="edit-driver" class="form-input" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                    </div>
                </div>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <div style="background: #fefce8; padding: 5px; border: 1px solid #fef08a;">
                    <label style="font-size: 10px; font-weight: bold; color: #854d0e;">TGL STUFFING</label>
                    <input type="date" id="edit-stuffing" class="form-input" style="width: 100%; padding: 5px; border: 1px solid #ccc;">
                </div>
                <div style="background: #f0fdf4; padding: 5px; border: 1px solid #bbf7d0;">
                    <label style="font-size: 10px; font-weight: bold; color: #166534;">TGL BONGKAR</label>
                    <input type="date" id="edit-bongkar" class="form-input" style="width: 100%; padding: 5px; border: 1px solid #ccc;">
                </div>
            </div>
        </div>

        <div style="margin-top: 20px; display: flex; justify-content: flex-end; gap: 10px;">
            <button onclick="tutupModal()" style="padding: 10px 20px; background: #94a3b8; color: white; border: none; border-radius: 4px; font-weight: bold; cursor: pointer;">BATAL</button>
            <button onclick="simpanPerubahan()" style="padding: 10px 20px; background: #2563eb; color: white; border: none; border-radius: 4px; font-weight: bold; cursor: pointer;">SIMPAN DATA</button>
        </div>
    </div>
</div>
</body>
</html>
